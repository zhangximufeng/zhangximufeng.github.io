<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>cookie是什么 | Myfun&#39;s Blog</title>
    <meta name="description" content="cookie">
    <link rel="icon" href="/favicon.ico">
    <meta name="keywords" content="cookie">
    <link rel="preload" href="/assets/css/0.styles.6bc9bf16.css" as="style"><link rel="preload" href="/assets/js/app.35b69267.js" as="script"><link rel="preload" href="/assets/js/32.da6d2ac6.js" as="script"><link rel="prefetch" href="/assets/js/10.a2f6c6ac.js"><link rel="prefetch" href="/assets/js/100.24b9a366.js"><link rel="prefetch" href="/assets/js/101.085f0585.js"><link rel="prefetch" href="/assets/js/102.66d5674f.js"><link rel="prefetch" href="/assets/js/103.7f71429c.js"><link rel="prefetch" href="/assets/js/104.13b0f535.js"><link rel="prefetch" href="/assets/js/105.0a093e85.js"><link rel="prefetch" href="/assets/js/106.a4a1db62.js"><link rel="prefetch" href="/assets/js/107.2634aacf.js"><link rel="prefetch" href="/assets/js/108.b393516d.js"><link rel="prefetch" href="/assets/js/109.769b78fb.js"><link rel="prefetch" href="/assets/js/11.fb483cc4.js"><link rel="prefetch" href="/assets/js/12.24a41994.js"><link rel="prefetch" href="/assets/js/13.a4762474.js"><link rel="prefetch" href="/assets/js/14.4a737bc9.js"><link rel="prefetch" href="/assets/js/15.548f4e99.js"><link rel="prefetch" href="/assets/js/16.b0d2654c.js"><link rel="prefetch" href="/assets/js/17.d43ab467.js"><link rel="prefetch" href="/assets/js/18.0c8f5f87.js"><link rel="prefetch" href="/assets/js/19.19ef59f8.js"><link rel="prefetch" href="/assets/js/2.436a35aa.js"><link rel="prefetch" href="/assets/js/20.24296203.js"><link rel="prefetch" href="/assets/js/21.c486888f.js"><link rel="prefetch" href="/assets/js/22.7e2305f9.js"><link rel="prefetch" href="/assets/js/23.e55bab1b.js"><link rel="prefetch" href="/assets/js/24.1468433c.js"><link rel="prefetch" href="/assets/js/25.6d82837f.js"><link rel="prefetch" href="/assets/js/26.3c4b2f18.js"><link rel="prefetch" href="/assets/js/27.21725a4f.js"><link rel="prefetch" href="/assets/js/28.db16c479.js"><link rel="prefetch" href="/assets/js/29.cb9512e5.js"><link rel="prefetch" href="/assets/js/3.5c82c0f7.js"><link rel="prefetch" href="/assets/js/30.a4c25096.js"><link rel="prefetch" href="/assets/js/31.81741530.js"><link rel="prefetch" href="/assets/js/33.f6164ecd.js"><link rel="prefetch" href="/assets/js/34.0344ad22.js"><link rel="prefetch" href="/assets/js/35.07d4c8d3.js"><link rel="prefetch" href="/assets/js/36.2c6adcff.js"><link rel="prefetch" href="/assets/js/37.ceb5e95e.js"><link rel="prefetch" href="/assets/js/38.d39e96e5.js"><link rel="prefetch" href="/assets/js/39.fcf34164.js"><link rel="prefetch" href="/assets/js/4.267db630.js"><link rel="prefetch" href="/assets/js/40.bdf31768.js"><link rel="prefetch" href="/assets/js/41.cc61eccd.js"><link rel="prefetch" href="/assets/js/42.042e4349.js"><link rel="prefetch" href="/assets/js/43.b385d348.js"><link rel="prefetch" href="/assets/js/44.7669f3e2.js"><link rel="prefetch" href="/assets/js/45.2fb532f4.js"><link rel="prefetch" href="/assets/js/46.0cc86442.js"><link rel="prefetch" href="/assets/js/47.30448b83.js"><link rel="prefetch" href="/assets/js/48.8893a5ed.js"><link rel="prefetch" href="/assets/js/49.ed7be1ae.js"><link rel="prefetch" href="/assets/js/5.d8a5933e.js"><link rel="prefetch" href="/assets/js/50.e4af394b.js"><link rel="prefetch" href="/assets/js/51.502ca2a7.js"><link rel="prefetch" href="/assets/js/52.f9768ea6.js"><link rel="prefetch" href="/assets/js/53.0c762369.js"><link rel="prefetch" href="/assets/js/54.dad23d00.js"><link rel="prefetch" href="/assets/js/55.4298d6a4.js"><link rel="prefetch" href="/assets/js/56.d8505fa7.js"><link rel="prefetch" href="/assets/js/57.63d197ce.js"><link rel="prefetch" href="/assets/js/58.ae9a3671.js"><link rel="prefetch" href="/assets/js/59.cb04d7cd.js"><link rel="prefetch" href="/assets/js/6.a83fef9a.js"><link rel="prefetch" href="/assets/js/60.0cedb385.js"><link rel="prefetch" href="/assets/js/61.a5c3f820.js"><link rel="prefetch" href="/assets/js/62.fc2d969d.js"><link rel="prefetch" href="/assets/js/63.53f087e3.js"><link rel="prefetch" href="/assets/js/64.9384bc9a.js"><link rel="prefetch" href="/assets/js/65.bb5db767.js"><link rel="prefetch" href="/assets/js/66.86940f42.js"><link rel="prefetch" href="/assets/js/67.37215862.js"><link rel="prefetch" href="/assets/js/68.e0c14875.js"><link rel="prefetch" href="/assets/js/69.276f0d65.js"><link rel="prefetch" href="/assets/js/7.7e7cde5e.js"><link rel="prefetch" href="/assets/js/70.0fb38ae4.js"><link rel="prefetch" href="/assets/js/71.7c824b27.js"><link rel="prefetch" href="/assets/js/72.bc39810c.js"><link rel="prefetch" href="/assets/js/73.9917d9a4.js"><link rel="prefetch" href="/assets/js/74.7912f7da.js"><link rel="prefetch" href="/assets/js/75.c193b7ec.js"><link rel="prefetch" href="/assets/js/76.ecd4e536.js"><link rel="prefetch" href="/assets/js/77.842c5aba.js"><link rel="prefetch" href="/assets/js/78.0a67366d.js"><link rel="prefetch" href="/assets/js/79.324df7d4.js"><link rel="prefetch" href="/assets/js/8.7063c274.js"><link rel="prefetch" href="/assets/js/80.68c6326b.js"><link rel="prefetch" href="/assets/js/81.a7df7b21.js"><link rel="prefetch" href="/assets/js/82.abd9c0c2.js"><link rel="prefetch" href="/assets/js/83.fd0d8457.js"><link rel="prefetch" href="/assets/js/84.148b432c.js"><link rel="prefetch" href="/assets/js/85.32148693.js"><link rel="prefetch" href="/assets/js/86.7dc5fe11.js"><link rel="prefetch" href="/assets/js/87.bd1be392.js"><link rel="prefetch" href="/assets/js/88.2c0b86aa.js"><link rel="prefetch" href="/assets/js/89.3038cc8d.js"><link rel="prefetch" href="/assets/js/9.5cab2997.js"><link rel="prefetch" href="/assets/js/90.fb4057a1.js"><link rel="prefetch" href="/assets/js/91.4aa5adaf.js"><link rel="prefetch" href="/assets/js/92.aea0a62e.js"><link rel="prefetch" href="/assets/js/93.e2d0e9a7.js"><link rel="prefetch" href="/assets/js/94.a9e33a20.js"><link rel="prefetch" href="/assets/js/95.7c55098e.js"><link rel="prefetch" href="/assets/js/96.c8dfe1c0.js"><link rel="prefetch" href="/assets/js/97.35fc7df3.js"><link rel="prefetch" href="/assets/js/98.551b3ede.js"><link rel="prefetch" href="/assets/js/99.a8f5ffc4.js">
    <link rel="stylesheet" href="/assets/css/0.styles.6bc9bf16.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div><div class="wrap"><div class="theme-container container no-sidebar"><header class="navbar"><div class="nav-header"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/logo.png" class="logo"> <span class="site-name can-hide">
        Myfun's Blog
      </span></a> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><a href="/interview/" class="nav-link">InterviewMap</a></div><div class="nav-item"><a href="https://zhangximufeng.github.io/css_tricks/" target="_blank" rel="noopener noreferrer" class="nav-link">CSS_Tricks</a></div><div class="nav-item"><a href="https://zhangximufeng.github.io/js_tricks/" target="_blank" rel="noopener noreferrer" class="nav-link">JS_Tricks</a></div><div class="nav-item"><a href="/tags/" class="nav-link">Tags</a></div><div class="nav-item"><a href="https://github.com/zhangximufeng" target="_blank" rel="noopener noreferrer" class="nav-link">Github</a></div><div class="nav-item"><a href="https://zhangximufeng.github.io/animate_resume_ts/" target="_blank" rel="noopener noreferrer" class="nav-link">About</a></div> <!----></nav> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div></div></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><a href="/interview/" class="nav-link">InterviewMap</a></div><div class="nav-item"><a href="https://zhangximufeng.github.io/css_tricks/" target="_blank" rel="noopener noreferrer" class="nav-link">CSS_Tricks</a></div><div class="nav-item"><a href="https://zhangximufeng.github.io/js_tricks/" target="_blank" rel="noopener noreferrer" class="nav-link">JS_Tricks</a></div><div class="nav-item"><a href="/tags/" class="nav-link">Tags</a></div><div class="nav-item"><a href="https://github.com/zhangximufeng" target="_blank" rel="noopener noreferrer" class="nav-link">Github</a></div><div class="nav-item"><a href="https://zhangximufeng.github.io/animate_resume_ts/" target="_blank" rel="noopener noreferrer" class="nav-link">About</a></div> <!----></nav> <!----></div> <div class="page-container"><div><div class="page card"><div class="content-header"><!----> <span class="page-timestamp">2018-09-29</span></div> <div class="content"><p></p><div class="table-of-contents"><ul><li><a href="#cookie是什么">cookie是什么</a><ul><li><a href="#_2-cookie的处理流程-t12-cookie的处理流程">2\. Cookie的处理流程 #</a></li><li><a href="#_3-使用步骤-t23-使用步骤">3\. 使用步骤 #</a></li><li><a href="#_4-cookie重要属性-t64-cookie重要属性">4\. cookie重要属性 #</a></li><li><a href="#_5-在express中向客户端发送cookie-t75-在express中向客户端发送cookie">5\. 在express中向客户端发送cookie #</a></li><li><a href="#_6-权限控制-t116-权限控制">6\. 权限控制 #</a></li><li><a href="#_7-cookie使用注意事项-t127-cookie使用注意事项">7.cookie使用注意事项 #</a></li></ul></li></ul></div><p></p> <h1 id="cookie是什么"><a href="#cookie是什么" aria-hidden="true" class="header-anchor">#</a> cookie是什么</h1> <hr> <ul><li>HTTP1.0中协议是无状态的，但在WEB应用中，在多个请求之间共享会话是非常必要的，所以出现了Cookie</li> <li>cookie是为了辩别用户身份，进行会话跟踪而_存储在客户端_上的数据</li></ul> <h2 id="_2-cookie的处理流程-t12-cookie的处理流程"><a href="#_2-cookie的处理流程-t12-cookie的处理流程" aria-hidden="true" class="header-anchor">#</a> 2. Cookie的处理流程 [#](#t12. Cookie的处理流程)</h2> <p><img src="assets/cookies.png" alt></p> <h2 id="_3-使用步骤-t23-使用步骤"><a href="#_3-使用步骤-t23-使用步骤" aria-hidden="true" class="header-anchor">#</a> 3. 使用步骤 [#](#t23. 使用步骤)</h2> <h3 id="_3-1-服务器发送cookie-t33-1-服务器发送cookie"><a href="#_3-1-服务器发送cookie-t33-1-服务器发送cookie" aria-hidden="true" class="header-anchor">#</a> 3.1 服务器发送cookie [#](#t33.1 服务器发送cookie)</h3> <p>客户端第一次访问服务器的时候服务器通过响应头向客户端发送Cookie,属性之间用分号空格分隔</p> <pre><code>Set-Cookie:name=zxmf; Path=/
</code></pre> <h3 id="_3-2-客户端接收保存cookie-t43-2-客户端接收保存cookie"><a href="#_3-2-客户端接收保存cookie-t43-2-客户端接收保存cookie" aria-hidden="true" class="header-anchor">#</a> 3.2 客户端接收保存cookie [#](#t43.2 客户端接收保存cookie)</h3> <p>客户端接收到Cookie之后保存在本地</p> <p><img src="http://7xjf2l.com1.z0.glb.clouddn.com/localcookie.jpg" alt></p> <h3 id="_3-3-客户端发送cookie-t53-3-客户端发送cookie"><a href="#_3-3-客户端发送cookie-t53-3-客户端发送cookie" aria-hidden="true" class="header-anchor">#</a> 3.3 客户端发送cookie [#](#t53.3 客户端发送cookie)</h3> <p>以后客户端再请求服务器的时候会把此Cookie发送到服务器端</p> <pre><code>Cookie:name=zxmf
</code></pre> <h2 id="_4-cookie重要属性-t64-cookie重要属性"><a href="#_4-cookie重要属性-t64-cookie重要属性" aria-hidden="true" class="header-anchor">#</a> 4. cookie重要属性 [#](#t64. cookie重要属性)</h2> <table><thead><tr><th>属性</th> <th>说明</th></tr></thead> <tbody><tr><td>name=value</td> <td>键值对，可以设置要保存的 Key/Value</td></tr> <tr><td>Domain</td> <td>域名，默认是当前域名</td></tr> <tr><td>maxAge</td> <td>最大失效时间(毫秒),设置在多少后失效</td></tr> <tr><td>secure</td> <td>当 secure 值为 true 时，cookie 在 HTTP 中是无效，在 HTTPS 中才有效</td></tr> <tr><td>Path</td> <td>表示 cookie 影响到的路，如 path=/。如果路径不能匹配时，浏览器则不发送这个Cookie</td></tr> <tr><td>Expires</td> <td>过期时间(秒)，在设置的某个时间点后该 Cookie 就会失效，如 expires=Money, 05-Dec-11 11:11:11 GMT</td></tr> <tr><td>httpOnly</td> <td>如果在COOKIE中设置了<code>httpOnly</code>属性，则通过程序(JS脚本)将无法读取到COOKIE信息，防止XSS攻击产生</td></tr></tbody></table> <h2 id="_5-在express中向客户端发送cookie-t75-在express中向客户端发送cookie"><a href="#_5-在express中向客户端发送cookie-t75-在express中向客户端发送cookie" aria-hidden="true" class="header-anchor">#</a> 5. 在express中向客户端发送cookie [#](#t75. 在express中向客户端发送cookie)</h2> <h3 id="_5-1-设置cookie-t85-1-设置cookie"><a href="#_5-1-设置cookie-t85-1-设置cookie" aria-hidden="true" class="header-anchor">#</a> 5.1 设置cookie [#](#t85.1 设置cookie)</h3> <div class="language-js extra-class"><pre class="language-js"><code> res<span class="token punctuation">.</span><span class="token function">cookie</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span>value<span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token punctuation">,</span>options<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><table><thead><tr><th>参数</th> <th>chrome对应属性</th> <th>类型</th> <th>说明</th> <th>示例</th></tr></thead> <tbody><tr><td>domain</td> <td>Domain</td> <td>String</td> <td>域名，默认是当前域名</td> <td>{domain:'a.zxmf.cn'}</td></tr> <tr><td>path</td> <td>Path</td> <td>String</td> <td>路径，默认是/</td> <td>{path:'/visit'}</td></tr> <tr><td>expires</td> <td>Expires</td> <td>Date</td> <td>过期时间，如果没以有指定或为0表示当前会话有效</td> <td>{expires:new Date(Date.now()+20*1000)}</td></tr> <tr><td>maxAge</td> <td>Max-Age</td> <td>Number</td> <td>有效时间(单位是毫秒)</td> <td>{maxAge:20*1000}</td></tr> <tr><td>httpOnly</td> <td>HTTP</td> <td>Boolean</td> <td>不能通过浏览器javascript访问</td> <td>{httpOnly:true}</td></tr> <tr><td>secure</td> <td>Secure</td> <td>String</td> <td>只通过https协议访问</td> <td></td></tr></tbody></table> <h3 id="_5-2-获取cookie-t95-2-获取cookie"><a href="#_5-2-获取cookie-t95-2-获取cookie" aria-hidden="true" class="header-anchor">#</a> 5.2 获取cookie [#](#t95.2 获取cookie)</h3> <p>使用cookie-parser中间件</p> <div class="language-bash extra-class"><pre class="language-bash"><code> <span class="token function">npm</span> <span class="token function">install</span> cookie-parser --save
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code>app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'cookie-parser'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//使用中间件</span>
response<span class="token punctuation">.</span><span class="token function">cookie</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span>value<span class="token punctuation">)</span>              <span class="token comment">//在响应中向客户端设置cookie</span>
request<span class="token punctuation">.</span>cookies                         <span class="token comment">//获取请求中的cookie对象</span>
response<span class="token punctuation">.</span><span class="token function">clearCookie</span><span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">)</span>        <span class="token comment">//清除cookie</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> cookieParser <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'cookie-parser'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/**
 * 如果要加密的话 cookieParser里要指定密码，而且signed要等于true res.cookie('name','zxmf',{signed:true});
 */</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">cookieParser</span><span class="token punctuation">(</span><span class="token string">'zxmf'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/write'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span>res<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">//1.普通设置</span>
    <span class="token comment">//res.cookie('name','value');</span>

    <span class="token comment">//2.设置域名</span>
    <span class="token comment">//res.cookie('name','zxmf',{domain:'a.zxmf.cn'});</span>

    <span class="token comment">//3.设置路径</span>
    <span class="token comment">//res.cookie('name','zxmf',{path:'/visit'});</span>

    <span class="token comment">//4.过期时间</span>
    <span class="token comment">//res.cookie('name','zxmf',{expires:new Date(Date.now()+20*1000)});//毫秒</span>
    <span class="token comment">//res.cookie('name','zxmf',{maxAge:20*1000});//过期时间 毫秒</span>

    <span class="token comment">//httpOnly true还是false无意义 document.cookie取不到</span>
    <span class="token comment">//res.cookie('name','zxmf',{httpOnly:true});</span>
    res<span class="token punctuation">.</span><span class="token function">cookie</span><span class="token punctuation">(</span><span class="token string">'age'</span><span class="token punctuation">,</span><span class="token string">'123'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>signed<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'ok'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/read'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span>res<span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>signedCookies<span class="token punctuation">)</span><span class="token punctuation">;</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>cookies<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//记录这是客户端的第几次访问</span>
app<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/visit'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span>res<span class="token punctuation">)</span><span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">cookie</span><span class="token punctuation">(</span><span class="token string">'count'</span><span class="token punctuation">,</span><span class="token function">isNaN</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>cookies<span class="token punctuation">.</span>count<span class="token punctuation">)</span><span class="token operator">?</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token function">parseInt</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>cookies<span class="token punctuation">.</span>count<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>cookies<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">9090</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="_5-3-cookie原理解析-t105-3-cookie原理解析"><a href="#_5-3-cookie原理解析-t105-3-cookie原理解析" aria-hidden="true" class="header-anchor">#</a> 5.3 cookie原理解析 [#](#t105.3 cookie原理解析)</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">cookieParser</span><span class="token punctuation">(</span>secret<span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">cookieParser</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span><span class="token punctuation">{</span>
    req<span class="token punctuation">.</span>secret <span class="token operator">=</span> secret<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>req<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>cookie<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    req<span class="token punctuation">.</span>cookies <span class="token operator">=</span>  <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'querystring'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>cookie<span class="token punctuation">,</span><span class="token string">'; '</span><span class="token punctuation">,</span><span class="token string">'='</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>secret<span class="token punctuation">)</span><span class="token punctuation">{</span>
        req<span class="token punctuation">.</span>signedCookies <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> attr <span class="token keyword">in</span> req<span class="token punctuation">.</span>cookies<span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">let</span> val <span class="token operator">=</span> req<span class="token punctuation">.</span>cookies<span class="token punctuation">[</span>attr<span class="token punctuation">]</span><span class="token punctuation">;</span>
                req<span class="token punctuation">.</span>signedCookies<span class="token punctuation">[</span>attr<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">unsign</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> secret<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">cookie</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> val<span class="token punctuation">,</span> options<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> opt <span class="token operator">=</span> options <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    val <span class="token operator">=</span> <span class="token function">encodeURIComponent</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>opt<span class="token punctuation">.</span>secret<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">var</span> secret <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>req<span class="token punctuation">.</span>secret<span class="token punctuation">;</span>
        val <span class="token operator">=</span> <span class="token function">sign</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span><span class="token keyword">this</span><span class="token punctuation">.</span>secret<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">var</span> pairs <span class="token operator">=</span> <span class="token punctuation">[</span>name <span class="token operator">+</span> <span class="token string">'='</span> <span class="token operator">+</span> value<span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> opt<span class="token punctuation">.</span>maxAge<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> maxAge <span class="token operator">=</span> opt<span class="token punctuation">.</span>maxAge <span class="token operator">-</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isNaN</span><span class="token punctuation">(</span>maxAge<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'maxAge should be a Number'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        pairs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'Max-Age='</span> <span class="token operator">+</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>maxAge<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>opt<span class="token punctuation">.</span>domain<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        pairs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'Domain='</span> <span class="token operator">+</span> opt<span class="token punctuation">.</span>domain<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>opt<span class="token punctuation">.</span>path<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        pairs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'Path='</span> <span class="token operator">+</span> opt<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>opt<span class="token punctuation">.</span>expires<span class="token punctuation">)</span> pairs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'Expires='</span> <span class="token operator">+</span> opt<span class="token punctuation">.</span>expires<span class="token punctuation">.</span><span class="token function">toUTCString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>opt<span class="token punctuation">.</span>httpOnly<span class="token punctuation">)</span> pairs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'HttpOnly=true'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>opt<span class="token punctuation">.</span>secure<span class="token punctuation">)</span> pairs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'Secure=true'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> pairs<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'; '</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> crypto <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'crypto'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
exports<span class="token punctuation">.</span><span class="token function-variable function">sign</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> secret<span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">return</span> val <span class="token operator">+</span> <span class="token string">'.'</span> <span class="token operator">+</span> crypto
    <span class="token punctuation">.</span><span class="token function">createHmac</span><span class="token punctuation">(</span><span class="token string">'sha256'</span><span class="token punctuation">,</span> secret<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">digest</span><span class="token punctuation">(</span><span class="token string">'base64'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/\=+$/</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

exports<span class="token punctuation">.</span><span class="token function-variable function">unsign</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> secret<span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">var</span> str <span class="token operator">=</span> val<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> val<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">,</span> mac <span class="token operator">=</span> exports<span class="token punctuation">.</span><span class="token function">sign</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span> secret<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> mac <span class="token operator">==</span> val <span class="token operator">?</span> str <span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="_6-权限控制-t116-权限控制"><a href="#_6-权限控制-t116-权限控制" aria-hidden="true" class="header-anchor">#</a> 6. 权限控制 [#](#t116. 权限控制)</h2> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> cookieParser <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'cookie-parser'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span><span class="token string">'view engine'</span><span class="token punctuation">,</span><span class="token string">'html'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">engine</span><span class="token punctuation">(</span><span class="token string">'html'</span><span class="token punctuation">,</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'ejs'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__express<span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span><span class="token string">'views'</span><span class="token punctuation">,</span>__dirname<span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">cookieParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">checkUser</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span>res<span class="token punctuation">,</span>next<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>cookies <span class="token operator">&amp;&amp;</span> req<span class="token punctuation">.</span>cookies<span class="token punctuation">.</span>username<span class="token punctuation">)</span>
      <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>
      res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//进入登录页</span>
app<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span>res<span class="token punctuation">)</span><span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'index'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//登录</span>
app<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/login'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span>res<span class="token punctuation">)</span><span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">cookie</span><span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">,</span>req<span class="token punctuation">.</span>query<span class="token punctuation">.</span>username<span class="token punctuation">,</span><span class="token punctuation">{</span>httpOnly<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'/user'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//用户页面</span>
app<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/user'</span><span class="token punctuation">,</span>checkUser<span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span>res<span class="token punctuation">)</span><span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'user'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>username<span class="token punctuation">:</span>req<span class="token punctuation">.</span>cookies<span class="token punctuation">.</span>username<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//用户退出</span>
app<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/logout'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span>res<span class="token punctuation">)</span><span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">clearCookie</span><span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//清除cookie</span>
    res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8080</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="_7-cookie使用注意事项"><a href="#_7-cookie使用注意事项" aria-hidden="true" class="header-anchor">#</a> 7.cookie使用注意事项 <a href="#t127.cookie%E4%BD%BF%E7%94%A8%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9">#</a></h2> <ul><li>可能被客户端篡改，使用前验证合法性</li> <li>不要存储敏感数据，比如用户密码，账户余额</li> <li>使用httpOnly保证安全</li> <li>尽量减少cookie的体积</li> <li>设置正确的domain和path，减少数据传输</li></ul></div> <!----> <div class="content page-nav"><p class="inner"><span class="prev">
          ← <a href="/fe/21.https.html" class="prev">
            http通信有什么问题?
          </a></span> <span class="next"><a href="/fe/23.session.html">
            什么是session
          </a> →
        </span></p></div> <div id="comment-container"><div class="gt-container"><div class="gt-initing"><i class="gt-loader"></i> <p class="gt-initing-text">Gitalking ...</p></div> <!----> <!----> <div><div class="gt-header"><a class="gt-avatar-github"><span class="gt-ico gt-ico-github"><span class="gt-svg"><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <path d="M64 524C64 719.602 189.356 885.926 364.113 947.017 387.65799 953 384 936.115 384 924.767L384 847.107C248.118 863.007 242.674 773.052 233.5 758.001 215 726.501 171.5 718.501 184.5 703.501 215.5 687.501 247 707.501 283.5 761.501 309.956 800.642 361.366 794.075 387.658 787.497 393.403 763.997 405.637 743.042 422.353 726.638 281.774 701.609 223 615.67 223 513.5 223 464.053 239.322 418.406 271.465 381.627 251.142 320.928 273.421 269.19 276.337 261.415 334.458 256.131 394.888 302.993 399.549 306.685 432.663 297.835 470.341 293 512.5 293 554.924 293 592.81 297.896 626.075 306.853 637.426 298.219 693.46 258.054 747.5 262.966 750.382 270.652 772.185 321.292 753.058 381.083 785.516 417.956 802 463.809 802 513.5 802 615.874 742.99 701.953 601.803 726.786 625.381 750.003 640 782.295 640 818.008L640 930.653C640.752 939.626 640 948.664978 655.086 948.665 832.344 888.962 960 721.389 960 524 960 276.576 759.424 76 512 76 264.577 76 64 276.576 64 524Z"></path>
</svg>
</span> <!----></span></a> <div class="gt-header-comment"><textarea placeholder="Leave a comment" class="gt-header-textarea"></textarea> <div class="gt-header-preview markdown-body hide"></div> <div class="gt-header-controls"><a href="https://guides.github.com/features/mastering-markdown/" target="_blank" class="gt-header-controls-tip"><span class="gt-ico gt-ico-tip"><span class="gt-svg"><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <path d="M512 366.949535c-16.065554 0-29.982212 13.405016-29.982212 29.879884l0 359.070251c0 16.167882 13.405016 29.879884 29.982212 29.879884 15.963226 0 29.879884-13.405016 29.879884-29.879884L541.879884 396.829419C541.879884 380.763865 528.474868 366.949535 512 366.949535L512 366.949535z"
    p-id="3083"></path>
  <path d="M482.017788 287.645048c0-7.776956 3.274508-15.553912 8.80024-21.181973 5.525732-5.525732 13.302688-8.80024 21.181973-8.80024 7.776956 0 15.553912 3.274508 21.079644 8.80024 5.525732 5.62806 8.80024 13.405016 8.80024 21.181973 0 7.776956-3.274508 15.656241-8.80024 21.181973-5.525732 5.525732-13.405016 8.697911-21.079644 8.697911-7.879285 0-15.656241-3.274508-21.181973-8.697911C485.292295 303.301289 482.017788 295.524333 482.017788 287.645048L482.017788 287.645048z"
    p-id="3084"></path>
  <path d="M512 946.844409c-239.8577 0-434.895573-195.037873-434.895573-434.895573 0-239.8577 195.037873-434.895573 434.895573-434.895573 239.755371 0 434.895573 195.037873 434.895573 434.895573C946.895573 751.806535 751.755371 946.844409 512 946.844409zM512 126.17088c-212.740682 0-385.880284 173.037274-385.880284 385.777955 0 212.740682 173.037274 385.777955 385.880284 385.777955 212.740682 0 385.777955-173.037274 385.777955-385.777955C897.777955 299.208154 724.740682 126.17088 512 126.17088z"
    p-id="3085"></path>
</svg>
</span> <span class="gt-ico-text">Markdown is supported</span></span></a> <!----> <button class="gt-btn gt-btn-preview"><span class="gt-btn-text">Preview</span> <!----></button> <button class="gt-btn gt-btn-login"><span class="gt-btn-text">Login with GitHub</span> <!----></button></div></div></div> <div class="gt-comments"><span></span> <p class="gt-comments-null">
                Be the first guy leaving a comment!
            </p> <!----></div></div></div></div></div></div> <!----></div> <div class="tool-group"><!----></div></div> <!----></div> <div class="background-mask" style="background:#f6f6f6;"></div></div></div>
    <script src="/assets/js/app.35b69267.js" defer></script><script src="/assets/js/32.da6d2ac6.js" defer></script>
  </body>
</html>
