<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>扩展mongoose模型 | Myfun&#39;s Blog</title>
    <meta name="description" content="MongoDB">
    <link rel="icon" href="/favicon.ico">
    <meta name="keywords" content="MongoDB">
    <link rel="preload" href="/assets/css/0.styles.6bc9bf16.css" as="style"><link rel="preload" href="/assets/js/app.35b69267.js" as="script"><link rel="preload" href="/assets/js/65.bb5db767.js" as="script"><link rel="prefetch" href="/assets/js/10.a2f6c6ac.js"><link rel="prefetch" href="/assets/js/100.24b9a366.js"><link rel="prefetch" href="/assets/js/101.085f0585.js"><link rel="prefetch" href="/assets/js/102.66d5674f.js"><link rel="prefetch" href="/assets/js/103.7f71429c.js"><link rel="prefetch" href="/assets/js/104.13b0f535.js"><link rel="prefetch" href="/assets/js/105.0a093e85.js"><link rel="prefetch" href="/assets/js/106.a4a1db62.js"><link rel="prefetch" href="/assets/js/107.2634aacf.js"><link rel="prefetch" href="/assets/js/108.b393516d.js"><link rel="prefetch" href="/assets/js/109.769b78fb.js"><link rel="prefetch" href="/assets/js/11.fb483cc4.js"><link rel="prefetch" href="/assets/js/12.24a41994.js"><link rel="prefetch" href="/assets/js/13.a4762474.js"><link rel="prefetch" href="/assets/js/14.4a737bc9.js"><link rel="prefetch" href="/assets/js/15.548f4e99.js"><link rel="prefetch" href="/assets/js/16.b0d2654c.js"><link rel="prefetch" href="/assets/js/17.d43ab467.js"><link rel="prefetch" href="/assets/js/18.0c8f5f87.js"><link rel="prefetch" href="/assets/js/19.19ef59f8.js"><link rel="prefetch" href="/assets/js/2.436a35aa.js"><link rel="prefetch" href="/assets/js/20.24296203.js"><link rel="prefetch" href="/assets/js/21.c486888f.js"><link rel="prefetch" href="/assets/js/22.7e2305f9.js"><link rel="prefetch" href="/assets/js/23.e55bab1b.js"><link rel="prefetch" href="/assets/js/24.1468433c.js"><link rel="prefetch" href="/assets/js/25.6d82837f.js"><link rel="prefetch" href="/assets/js/26.3c4b2f18.js"><link rel="prefetch" href="/assets/js/27.21725a4f.js"><link rel="prefetch" href="/assets/js/28.db16c479.js"><link rel="prefetch" href="/assets/js/29.cb9512e5.js"><link rel="prefetch" href="/assets/js/3.5c82c0f7.js"><link rel="prefetch" href="/assets/js/30.a4c25096.js"><link rel="prefetch" href="/assets/js/31.81741530.js"><link rel="prefetch" href="/assets/js/32.da6d2ac6.js"><link rel="prefetch" href="/assets/js/33.f6164ecd.js"><link rel="prefetch" href="/assets/js/34.0344ad22.js"><link rel="prefetch" href="/assets/js/35.07d4c8d3.js"><link rel="prefetch" href="/assets/js/36.2c6adcff.js"><link rel="prefetch" href="/assets/js/37.ceb5e95e.js"><link rel="prefetch" href="/assets/js/38.d39e96e5.js"><link rel="prefetch" href="/assets/js/39.fcf34164.js"><link rel="prefetch" href="/assets/js/4.267db630.js"><link rel="prefetch" href="/assets/js/40.bdf31768.js"><link rel="prefetch" href="/assets/js/41.cc61eccd.js"><link rel="prefetch" href="/assets/js/42.042e4349.js"><link rel="prefetch" href="/assets/js/43.b385d348.js"><link rel="prefetch" href="/assets/js/44.7669f3e2.js"><link rel="prefetch" href="/assets/js/45.2fb532f4.js"><link rel="prefetch" href="/assets/js/46.0cc86442.js"><link rel="prefetch" href="/assets/js/47.30448b83.js"><link rel="prefetch" href="/assets/js/48.8893a5ed.js"><link rel="prefetch" href="/assets/js/49.ed7be1ae.js"><link rel="prefetch" href="/assets/js/5.d8a5933e.js"><link rel="prefetch" href="/assets/js/50.e4af394b.js"><link rel="prefetch" href="/assets/js/51.502ca2a7.js"><link rel="prefetch" href="/assets/js/52.f9768ea6.js"><link rel="prefetch" href="/assets/js/53.0c762369.js"><link rel="prefetch" href="/assets/js/54.dad23d00.js"><link rel="prefetch" href="/assets/js/55.4298d6a4.js"><link rel="prefetch" href="/assets/js/56.d8505fa7.js"><link rel="prefetch" href="/assets/js/57.63d197ce.js"><link rel="prefetch" href="/assets/js/58.ae9a3671.js"><link rel="prefetch" href="/assets/js/59.cb04d7cd.js"><link rel="prefetch" href="/assets/js/6.a83fef9a.js"><link rel="prefetch" href="/assets/js/60.0cedb385.js"><link rel="prefetch" href="/assets/js/61.a5c3f820.js"><link rel="prefetch" href="/assets/js/62.fc2d969d.js"><link rel="prefetch" href="/assets/js/63.53f087e3.js"><link rel="prefetch" href="/assets/js/64.9384bc9a.js"><link rel="prefetch" href="/assets/js/66.86940f42.js"><link rel="prefetch" href="/assets/js/67.37215862.js"><link rel="prefetch" href="/assets/js/68.e0c14875.js"><link rel="prefetch" href="/assets/js/69.276f0d65.js"><link rel="prefetch" href="/assets/js/7.7e7cde5e.js"><link rel="prefetch" href="/assets/js/70.0fb38ae4.js"><link rel="prefetch" href="/assets/js/71.7c824b27.js"><link rel="prefetch" href="/assets/js/72.bc39810c.js"><link rel="prefetch" href="/assets/js/73.9917d9a4.js"><link rel="prefetch" href="/assets/js/74.7912f7da.js"><link rel="prefetch" href="/assets/js/75.c193b7ec.js"><link rel="prefetch" href="/assets/js/76.ecd4e536.js"><link rel="prefetch" href="/assets/js/77.842c5aba.js"><link rel="prefetch" href="/assets/js/78.0a67366d.js"><link rel="prefetch" href="/assets/js/79.324df7d4.js"><link rel="prefetch" href="/assets/js/8.7063c274.js"><link rel="prefetch" href="/assets/js/80.68c6326b.js"><link rel="prefetch" href="/assets/js/81.a7df7b21.js"><link rel="prefetch" href="/assets/js/82.abd9c0c2.js"><link rel="prefetch" href="/assets/js/83.fd0d8457.js"><link rel="prefetch" href="/assets/js/84.148b432c.js"><link rel="prefetch" href="/assets/js/85.32148693.js"><link rel="prefetch" href="/assets/js/86.7dc5fe11.js"><link rel="prefetch" href="/assets/js/87.bd1be392.js"><link rel="prefetch" href="/assets/js/88.2c0b86aa.js"><link rel="prefetch" href="/assets/js/89.3038cc8d.js"><link rel="prefetch" href="/assets/js/9.5cab2997.js"><link rel="prefetch" href="/assets/js/90.fb4057a1.js"><link rel="prefetch" href="/assets/js/91.4aa5adaf.js"><link rel="prefetch" href="/assets/js/92.aea0a62e.js"><link rel="prefetch" href="/assets/js/93.e2d0e9a7.js"><link rel="prefetch" href="/assets/js/94.a9e33a20.js"><link rel="prefetch" href="/assets/js/95.7c55098e.js"><link rel="prefetch" href="/assets/js/96.c8dfe1c0.js"><link rel="prefetch" href="/assets/js/97.35fc7df3.js"><link rel="prefetch" href="/assets/js/98.551b3ede.js"><link rel="prefetch" href="/assets/js/99.a8f5ffc4.js">
    <link rel="stylesheet" href="/assets/css/0.styles.6bc9bf16.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div><div class="wrap"><div class="theme-container container no-sidebar"><header class="navbar"><div class="nav-header"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/logo.png" class="logo"> <span class="site-name can-hide">
        Myfun's Blog
      </span></a> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><a href="/interview/" class="nav-link">InterviewMap</a></div><div class="nav-item"><a href="https://zhangximufeng.github.io/css_tricks/" target="_blank" rel="noopener noreferrer" class="nav-link">CSS_Tricks</a></div><div class="nav-item"><a href="https://zhangximufeng.github.io/js_tricks/" target="_blank" rel="noopener noreferrer" class="nav-link">JS_Tricks</a></div><div class="nav-item"><a href="/tags/" class="nav-link">Tags</a></div><div class="nav-item"><a href="https://github.com/zhangximufeng" target="_blank" rel="noopener noreferrer" class="nav-link">Github</a></div><div class="nav-item"><a href="https://zhangximufeng.github.io/animate_resume_ts/" target="_blank" rel="noopener noreferrer" class="nav-link">About</a></div> <!----></nav> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div></div></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><a href="/interview/" class="nav-link">InterviewMap</a></div><div class="nav-item"><a href="https://zhangximufeng.github.io/css_tricks/" target="_blank" rel="noopener noreferrer" class="nav-link">CSS_Tricks</a></div><div class="nav-item"><a href="https://zhangximufeng.github.io/js_tricks/" target="_blank" rel="noopener noreferrer" class="nav-link">JS_Tricks</a></div><div class="nav-item"><a href="/tags/" class="nav-link">Tags</a></div><div class="nav-item"><a href="https://github.com/zhangximufeng" target="_blank" rel="noopener noreferrer" class="nav-link">Github</a></div><div class="nav-item"><a href="https://zhangximufeng.github.io/animate_resume_ts/" target="_blank" rel="noopener noreferrer" class="nav-link">About</a></div> <!----></nav> <!----></div> <div class="page-container"><div><div class="page card"><div class="content-header"><!----> <span class="page-timestamp">2018-09-29</span></div> <div class="content"><p></p><div class="table-of-contents"><ul><li><a href="#扩展mongoose模型">扩展mongoose模型</a><ul><li><a href="#_2-statics-对类进行扩展-t12-statics-对类进行扩展">2\. statics 对类进行扩展 #</a></li><li><a href="#_3-methods-对实例进行扩展-t23-methods-对实例进行扩展">3\. methods 对实例进行扩展 #</a></li><li><a href="#_4-virutal虚拟属性-t34-virutal虚拟属性">4\. virutal虚拟属性 #</a></li><li><a href="#_5-hook-t45-hook">5\. hook #</a></li><li><a href="#_6-schema-插件-t56-schema-插件">6\. schema 插件 #</a></li><li><a href="#_7-mongodb-聚合-t67-mongodb-聚合">7.MongoDB 聚合 #</a></li></ul></li></ul></div><p></p> <h1 id="扩展mongoose模型"><a href="#扩展mongoose模型" aria-hidden="true" class="header-anchor">#</a> 扩展mongoose模型</h1> <hr> <p>业务分层</p> <blockquote><p>service(多个模型)-&gt;dao单个模型-&gt;model 模型定义</p> <p>service(多个模型)-&gt;dao单个模型-&gt;model (模型定义+扩展方法)</p></blockquote> <h2 id="_2-statics-对类进行扩展-t12-statics-对类进行扩展"><a href="#_2-statics-对类进行扩展-t12-statics-对类进行扩展" aria-hidden="true" class="header-anchor">#</a> 2. statics 对类进行扩展 [#](#t12. statics 对类进行扩展)</h2> <p>根据用户名查找用户文档</p> <div class="language-js extra-class"><pre class="language-js"><code> <span class="token comment">//this指向model</span>
PersonSchema<span class="token punctuation">.</span>statics<span class="token punctuation">.</span><span class="token function-variable function">findByUsername</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>username<span class="token punctuation">,</span> callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span> username <span class="token punctuation">}</span><span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
Person<span class="token punctuation">.</span><span class="token function">findByUsername</span><span class="token punctuation">(</span><span class="token string">'zxmf'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>err<span class="token punctuation">,</span> doc<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>doc<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="_3-methods-对实例进行扩展-t23-methods-对实例进行扩展"><a href="#_3-methods-对实例进行扩展-t23-methods-对实例进行扩展" aria-hidden="true" class="header-anchor">#</a> 3. methods 对实例进行扩展 [#](#t23. methods 对实例进行扩展)</h2> <div class="language-js extra-class"><pre class="language-js"><code>PersonSchema<span class="token punctuation">.</span>methods<span class="token punctuation">.</span><span class="token function-variable function">exist</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> query <span class="token operator">=</span> <span class="token punctuation">{</span> username<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>username<span class="token punctuation">,</span> password<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>password <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">model</span><span class="token punctuation">(</span><span class="token string">'Person'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span>query<span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">let</span> person <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token punctuation">{</span> username<span class="token punctuation">:</span> <span class="token string">'zxmf'</span><span class="token punctuation">,</span> password<span class="token punctuation">:</span> <span class="token string">'123456'</span><span class="token punctuation">,</span> phone<span class="token punctuation">:</span> <span class="token string">'010-6255889'</span><span class="token punctuation">,</span> firstname<span class="token punctuation">:</span> <span class="token string">'first'</span><span class="token punctuation">,</span> lastname<span class="token punctuation">:</span> <span class="token string">'last'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
person<span class="token punctuation">.</span><span class="token function">exist</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>err<span class="token punctuation">,</span> doc<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> doc<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="_4-virutal虚拟属性-t34-virutal虚拟属性"><a href="#_4-virutal虚拟属性-t34-virutal虚拟属性" aria-hidden="true" class="header-anchor">#</a> 4. virutal虚拟属性 [#](#t34. virutal虚拟属性)</h2> <ul><li><p>virtual是虚拟属性的意思，即原来Schema定义里是不存在该属性，后来通过virutal方法赋予的属性。</p></li> <li><p>Schema中定义的属性是要保存到数据库里的，而virtual属性基于已有属性做的二次定义。</p> <blockquote><p>模型属性 = Schema定义的属性+virtual属性</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code>PersonSchema<span class="token punctuation">.</span><span class="token function">virtual</span><span class="token punctuation">(</span><span class="token string">'area'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//this指向实例</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>phone<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'-'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
PersonSchema<span class="token punctuation">.</span><span class="token function">virtual</span><span class="token punctuation">(</span><span class="token string">'number'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>phone<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'-'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> Person <span class="token operator">=</span> conn<span class="token punctuation">.</span><span class="token function">model</span><span class="token punctuation">(</span><span class="token string">'Person'</span><span class="token punctuation">,</span> PersonSchema<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> person <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token punctuation">{</span> username<span class="token punctuation">:</span> <span class="token string">'zxmf'</span><span class="token punctuation">,</span> password<span class="token punctuation">:</span> <span class="token string">'123456'</span><span class="token punctuation">,</span> phone<span class="token punctuation">:</span> <span class="token string">'010-6255889'</span><span class="token punctuation">,</span> firstname<span class="token punctuation">:</span> <span class="token string">'first'</span><span class="token punctuation">,</span> lastname<span class="token punctuation">:</span> <span class="token string">'last'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>person<span class="token punctuation">.</span>fullname<span class="token punctuation">,</span> person<span class="token punctuation">.</span>area<span class="token punctuation">,</span> person<span class="token punctuation">.</span>number<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></li></ul> <h2 id="_5-hook-t45-hook"><a href="#_5-hook-t45-hook" aria-hidden="true" class="header-anchor">#</a> 5. hook [#](#t45. hook)</h2> <p>在用户注册保存的时候，需要先把密码通过salt生成hash密码，并再次赋给password</p> <div class="language-js extra-class"><pre class="language-js"><code>PersonSchema<span class="token punctuation">.</span><span class="token function">pre</span><span class="token punctuation">(</span><span class="token string">'save'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>password <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">createHmac</span><span class="token punctuation">(</span><span class="token string">'sha256'</span><span class="token punctuation">,</span> <span class="token string">'zxmf'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>password<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">digest</span><span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

PersonSchema<span class="token punctuation">.</span>statics<span class="token punctuation">.</span><span class="token function-variable function">login</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>username<span class="token punctuation">,</span> password<span class="token punctuation">,</span> callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    password <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">createHmac</span><span class="token punctuation">(</span><span class="token string">'sha256'</span><span class="token punctuation">,</span> <span class="token string">'zxmf'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">digest</span><span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span> username<span class="token punctuation">,</span> password <span class="token punctuation">}</span><span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

Person<span class="token punctuation">.</span><span class="token function">login</span><span class="token punctuation">(</span><span class="token string">'zxmf'</span><span class="token punctuation">,</span> <span class="token string">'123456'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>err<span class="token punctuation">,</span> doc<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> doc<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="_6-schema-插件-t56-schema-插件"><a href="#_6-schema-插件-t56-schema-插件" aria-hidden="true" class="header-anchor">#</a> 6. schema 插件 [#](#t56. schema 插件)</h2> <p>Schemas是可插拔的，也就是说，它们提供在应用预先打包能力来扩展他们的功能。</p> <div class="language-js extra-class"><pre class="language-js"><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">lastModified</span><span class="token punctuation">(</span>schema<span class="token punctuation">,</span>options<span class="token punctuation">)</span><span class="token punctuation">{</span>
  schema<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">{</span>lastModify<span class="token punctuation">:</span>Date<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  schema<span class="token punctuation">.</span><span class="token function">pre</span><span class="token punctuation">(</span><span class="token string">'save'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span>next<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>lastModify <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">;</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>options<span class="token operator">&amp;&amp;</span> options<span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token punctuation">{</span>
    schema<span class="token punctuation">.</span><span class="token function">path</span><span class="token punctuation">(</span><span class="token string">'lastModify'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> plugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./plugin'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> Person <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Schema</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Person<span class="token punctuation">.</span><span class="token function">plugin</span><span class="token punctuation">(</span>plugin<span class="token punctuation">,</span><span class="token punctuation">{</span>index<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li><p>Person 是用户自己定义的Schema</p></li> <li><p>Person.plugin 是为Person增加plugin</p></li> <li><p>plugin有2个参数</p> <ul><li>插件对象 plugin</li> <li>配置项 {index:true}</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>schema<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">{</span>age<span class="token punctuation">:</span>Number<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></li></ul> <h2 id="_7-mongodb-聚合-t67-mongodb-聚合"><a href="#_7-mongodb-聚合-t67-mongodb-聚合" aria-hidden="true" class="header-anchor">#</a> 7.MongoDB 聚合 [#](#t67.MongoDB 聚合)</h2> <p>MongoDB中聚合(aggregate)主要用于处理数据(诸如统计平均值,求和等)，并返回计算后的数据结果。有点类似sql语句中的 count(*)。 aggregate() 方法 MongoDB中聚合的方法使用aggregate()。</p> <h3 id="_7-1-语法-t77-1-语法"><a href="#_7-1-语法-t77-1-语法" aria-hidden="true" class="header-anchor">#</a> 7.1 语法 [#](#t77.1 语法)</h3> <p>aggregate() 方法的基本语法格式如下所示：</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token operator">&gt;</span>db<span class="token punctuation">.</span>COLLECTION_NAME<span class="token punctuation">.</span>aggregate<span class="token punctuation">(</span>AGGREGATE_OPERATION<span class="token punctuation">)</span>
</code></pre></div><h3 id="_7-2-分组-t87-2-分组"><a href="#_7-2-分组-t87-2-分组" aria-hidden="true" class="header-anchor">#</a> 7.2 分组 [#](#t87.2 分组)</h3> <p>现在我们通过以上集合计算每个作者所写的文章数，使用aggregate()计算结果如下：</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token operator">&gt;</span> db<span class="token punctuation">.</span>article<span class="token punctuation">.</span><span class="token keyword">insert</span><span class="token punctuation">(</span>{uid:<span class="token number">1</span><span class="token punctuation">,</span>content:<span class="token string">'1'</span>}<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">&gt;</span> db<span class="token punctuation">.</span>article<span class="token punctuation">.</span><span class="token keyword">insert</span><span class="token punctuation">(</span>{uid:<span class="token number">2</span><span class="token punctuation">,</span>content:<span class="token string">'2'</span>}<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">&gt;</span> db<span class="token punctuation">.</span>article<span class="token punctuation">.</span><span class="token keyword">insert</span><span class="token punctuation">(</span>{uid:<span class="token number">1</span><span class="token punctuation">,</span>content:<span class="token string">'3'</span>}<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-sql extra-class"><pre class="language-sql"><code> db<span class="token punctuation">.</span>article<span class="token punctuation">.</span>aggregate<span class="token punctuation">(</span><span class="token punctuation">[</span>{$<span class="token keyword">group</span>:{_id:<span class="token string">'$uid'</span><span class="token punctuation">,</span>total:{$sum:<span class="token number">1</span>}}}<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 { <span class="token string">&quot;_id&quot;</span> : <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">&quot;total&quot;</span> : <span class="token number">1</span> }
{ <span class="token string">&quot;_id&quot;</span> : <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">&quot;total&quot;</span> : <span class="token number">2</span> }
<span class="token punctuation">`</span>
</code></pre></div><blockquote><p>select uid, count(*) total from article group by uid</p></blockquote> <h3 id="_7-3-聚合的表达式-t97-3-聚合的表达式"><a href="#_7-3-聚合的表达式-t97-3-聚合的表达式" aria-hidden="true" class="header-anchor">#</a> 7.3 聚合的表达式 [#](#t97.3 聚合的表达式)</h3> <table><thead><tr><th>表达式</th> <th>描述</th> <th>实例</th></tr></thead> <tbody><tr><td>$sum</td> <td>计算总和。</td> <td>db.mycol.aggregate([{$group : {_id : &quot;$uid&quot;, num_tutorial : {$sum : &quot;$visit&quot;}}}])</td></tr> <tr><td>$avg</td> <td>计算平均值</td> <td>db.mycol.aggregate([{$group : {_id : &quot;$uid&quot;, num_tutorial : {$avg : &quot;$visit&quot;}}}])</td></tr> <tr><td>$min</td> <td>获取集合中所有文档对应值得最小值。</td> <td>db.mycol.aggregate([{$group : {_id : &quot;$uid&quot;, num_tutorial : {$min : &quot;$visit&quot;}}}])</td></tr> <tr><td>$max</td> <td>获取集合中所有文档对应值得最大值。</td> <td>db.mycol.aggregate([{$group : {_id : &quot;$uid&quot;, num_tutorial : {$max : &quot;$visit&quot;}}}])</td></tr> <tr><td>$push</td> <td>在结果文档中插入值到一个数组中。</td> <td>db.mycol.aggregate([{$group : {_id : &quot;$uid&quot;, url : {$push: &quot;$url&quot;}}}])</td></tr> <tr><td>$addToSet</td> <td>在结果文档中插入值到一个数组中，但不创建副本。</td> <td>db.mycol.aggregate([{$group : {_id : &quot;$uid&quot;, url : {$addToSet : &quot;$url&quot;}}}])</td></tr> <tr><td>$first</td> <td>根据资源文档的排序获取第一个文档数据。</td> <td>db.mycol.aggregate([{$group : {_id : &quot;$uid&quot;, first_url : {$first : &quot;$url&quot;}}}])</td></tr> <tr><td>$last</td> <td>根据资源文档的排序获取最后一个文档数据</td> <td>db.mycol.aggregate([{$group : {_id : &quot;$uid&quot;, last_url : {$last : &quot;$url&quot;}}}])</td></tr></tbody></table> <div class="language-sql extra-class"><pre class="language-sql"><code>db<span class="token punctuation">.</span>article<span class="token punctuation">.</span><span class="token keyword">insert</span><span class="token punctuation">(</span>{uid:<span class="token number">1</span><span class="token punctuation">,</span>content:<span class="token string">'3'</span><span class="token punctuation">,</span>url:<span class="token string">'url1'</span>}<span class="token punctuation">)</span><span class="token punctuation">;</span>
db<span class="token punctuation">.</span>article<span class="token punctuation">.</span>aggregate<span class="token punctuation">(</span><span class="token punctuation">[</span>{$<span class="token keyword">group</span> : {_id : <span class="token string">&quot;$uid&quot;</span><span class="token punctuation">,</span> url : {$push: <span class="token string">&quot;$url&quot;</span>}}}<span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="_7-4-管道的概念-t107-4-管道的概念"><a href="#_7-4-管道的概念-t107-4-管道的概念" aria-hidden="true" class="header-anchor">#</a> 7.4 管道的概念 [#](#t107.4 管道的概念)</h3> <p>管道在Unix和Linux中一般用于将当前命令的输出结果作为下一个命令的参数。 MongoDB的聚合管道将MongoDB文档在一个管道处理完毕后将结果传递给下一个管道处理。管道操作是可以重复的。</p> <ul><li>$project：修改输入文档的结构。可以用来重命名、增加或删除域，也可以用于创建计算结果以及嵌套文档。</li> <li><code>$match：用于过滤数据，只输出符合条件的文档。$match使用MongoDB的标准查询操作</code>。</li> <li>$limit：用来限制MongoDB聚合管道返回的文档数。</li> <li>$skip：在聚合管道中跳过指定数量的文档，并返回余下的文档。</li> <li>$unwind：将文档中的某一个数组类型字段拆分成多条，每条包含数组中的一个值。</li> <li>$group：将集合中的文档分组，可用于统计结果。</li> <li>$sort：将输入文档排序后输出。</li></ul> <h4 id="_7-4-1-过滤显示字段-t117-4-1-过滤显示字段"><a href="#_7-4-1-过滤显示字段-t117-4-1-过滤显示字段" aria-hidden="true" class="header-anchor">#</a> 7.4.1 过滤显示字段 [#](#t117.4.1 过滤显示字段)</h4> <div class="language-sql extra-class"><pre class="language-sql"><code>db<span class="token punctuation">.</span>article<span class="token punctuation">.</span>aggregate<span class="token punctuation">(</span>
    { $project : {
        _id:<span class="token number">0</span><span class="token punctuation">,</span>
        content : <span class="token number">1</span> <span class="token punctuation">,</span>
    }}
 <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="_7-4-2-过滤文档-t127-4-2-过滤文档"><a href="#_7-4-2-过滤文档-t127-4-2-过滤文档" aria-hidden="true" class="header-anchor">#</a> 7.4.2 过滤文档 [#](#t127.4.2 过滤文档)</h4> <div class="language-sql extra-class"><pre class="language-sql"><code>db<span class="token punctuation">.</span>article<span class="token punctuation">.</span>aggregate<span class="token punctuation">(</span> <span class="token punctuation">[</span>
  { $<span class="token keyword">match</span> : { visit : { $gt : <span class="token number">10</span><span class="token punctuation">,</span> $lte : <span class="token number">200</span> } } }<span class="token punctuation">,</span>
  { $<span class="token keyword">group</span>: { _id: <span class="token string">'$uid'</span><span class="token punctuation">,</span> count: { $sum: <span class="token number">1</span> } } }
<span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="_7-4-3-跳过指定数量-t137-4-3-跳过指定数量"><a href="#_7-4-3-跳过指定数量-t137-4-3-跳过指定数量" aria-hidden="true" class="header-anchor">#</a> 7.4.3 跳过指定数量 [#](#t137.4.3 跳过指定数量)</h4> <div class="language-sql extra-class"><pre class="language-sql"><code>db<span class="token punctuation">.</span>article<span class="token punctuation">.</span>aggregate<span class="token punctuation">(</span> <span class="token punctuation">[</span>
  { $<span class="token keyword">match</span> : { visit : { $gt : <span class="token number">10</span><span class="token punctuation">,</span> $lte : <span class="token number">200</span> } } }<span class="token punctuation">,</span>
  { $<span class="token keyword">group</span>: { _id: <span class="token string">'$uid'</span><span class="token punctuation">,</span> count: { $sum: <span class="token number">1</span> } } }<span class="token punctuation">,</span>
  { $skip : <span class="token number">1</span> }
<span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="_7-4-4-mongoose中使用-t147-4-4-mongoose中使用"><a href="#_7-4-4-mongoose中使用-t147-4-4-mongoose中使用" aria-hidden="true" class="header-anchor">#</a> 7.4.4 Mongoose中使用 [#](#t147.4.4 Mongoose中使用)</h4> <div class="language-sql extra-class"><pre class="language-sql"><code>Article<span class="token punctuation">.</span>aggregate<span class="token punctuation">(</span><span class="token punctuation">[</span>
  { $<span class="token keyword">match</span> : { visit : { $gt : <span class="token number">10</span><span class="token punctuation">,</span> $lte : <span class="token number">200</span> } } }<span class="token punctuation">,</span>
  { $<span class="token keyword">group</span>: { _id: <span class="token string">'$uid'</span><span class="token punctuation">,</span> count: { $sum: <span class="token number">1</span> } } }<span class="token punctuation">,</span>
  { $skip : <span class="token number">1</span> }
 <span class="token punctuation">]</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span>
</code></pre></div><ul><li><a href="https://github.com/sodino/MongoDemo/blob/master/app.js" target="_blank" rel="noopener noreferrer">MongoDemo<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div> <!----> <div class="content page-nav"><p class="inner"><span class="prev">
          ← <a href="/fe/29.mongodb-5.html" class="prev">
            MongoDB简介
          </a></span> <span class="next"><a href="/fe/29.mongodb-2.html">
            通过配置项启动数据库
          </a> →
        </span></p></div> <div id="comment-container"><div class="gt-container"><div class="gt-initing"><i class="gt-loader"></i> <p class="gt-initing-text">Gitalking ...</p></div> <!----> <!----> <div><div class="gt-header"><a class="gt-avatar-github"><span class="gt-ico gt-ico-github"><span class="gt-svg"><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <path d="M64 524C64 719.602 189.356 885.926 364.113 947.017 387.65799 953 384 936.115 384 924.767L384 847.107C248.118 863.007 242.674 773.052 233.5 758.001 215 726.501 171.5 718.501 184.5 703.501 215.5 687.501 247 707.501 283.5 761.501 309.956 800.642 361.366 794.075 387.658 787.497 393.403 763.997 405.637 743.042 422.353 726.638 281.774 701.609 223 615.67 223 513.5 223 464.053 239.322 418.406 271.465 381.627 251.142 320.928 273.421 269.19 276.337 261.415 334.458 256.131 394.888 302.993 399.549 306.685 432.663 297.835 470.341 293 512.5 293 554.924 293 592.81 297.896 626.075 306.853 637.426 298.219 693.46 258.054 747.5 262.966 750.382 270.652 772.185 321.292 753.058 381.083 785.516 417.956 802 463.809 802 513.5 802 615.874 742.99 701.953 601.803 726.786 625.381 750.003 640 782.295 640 818.008L640 930.653C640.752 939.626 640 948.664978 655.086 948.665 832.344 888.962 960 721.389 960 524 960 276.576 759.424 76 512 76 264.577 76 64 276.576 64 524Z"></path>
</svg>
</span> <!----></span></a> <div class="gt-header-comment"><textarea placeholder="Leave a comment" class="gt-header-textarea"></textarea> <div class="gt-header-preview markdown-body hide"></div> <div class="gt-header-controls"><a href="https://guides.github.com/features/mastering-markdown/" target="_blank" class="gt-header-controls-tip"><span class="gt-ico gt-ico-tip"><span class="gt-svg"><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <path d="M512 366.949535c-16.065554 0-29.982212 13.405016-29.982212 29.879884l0 359.070251c0 16.167882 13.405016 29.879884 29.982212 29.879884 15.963226 0 29.879884-13.405016 29.879884-29.879884L541.879884 396.829419C541.879884 380.763865 528.474868 366.949535 512 366.949535L512 366.949535z"
    p-id="3083"></path>
  <path d="M482.017788 287.645048c0-7.776956 3.274508-15.553912 8.80024-21.181973 5.525732-5.525732 13.302688-8.80024 21.181973-8.80024 7.776956 0 15.553912 3.274508 21.079644 8.80024 5.525732 5.62806 8.80024 13.405016 8.80024 21.181973 0 7.776956-3.274508 15.656241-8.80024 21.181973-5.525732 5.525732-13.405016 8.697911-21.079644 8.697911-7.879285 0-15.656241-3.274508-21.181973-8.697911C485.292295 303.301289 482.017788 295.524333 482.017788 287.645048L482.017788 287.645048z"
    p-id="3084"></path>
  <path d="M512 946.844409c-239.8577 0-434.895573-195.037873-434.895573-434.895573 0-239.8577 195.037873-434.895573 434.895573-434.895573 239.755371 0 434.895573 195.037873 434.895573 434.895573C946.895573 751.806535 751.755371 946.844409 512 946.844409zM512 126.17088c-212.740682 0-385.880284 173.037274-385.880284 385.777955 0 212.740682 173.037274 385.777955 385.880284 385.777955 212.740682 0 385.777955-173.037274 385.777955-385.777955C897.777955 299.208154 724.740682 126.17088 512 126.17088z"
    p-id="3085"></path>
</svg>
</span> <span class="gt-ico-text">Markdown is supported</span></span></a> <!----> <button class="gt-btn gt-btn-preview"><span class="gt-btn-text">Preview</span> <!----></button> <button class="gt-btn gt-btn-login"><span class="gt-btn-text">Login with GitHub</span> <!----></button></div></div></div> <div class="gt-comments"><span></span> <p class="gt-comments-null">
                Be the first guy leaving a comment!
            </p> <!----></div></div></div></div></div></div> <!----></div> <div class="tool-group"><!----></div></div> <!----></div> <div class="background-mask" style="background:#f6f6f6;"></div></div></div>
    <script src="/assets/js/app.35b69267.js" defer></script><script src="/assets/js/65.bb5db767.js" defer></script>
  </body>
</html>
