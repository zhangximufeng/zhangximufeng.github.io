<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>主从复制 | Myfun&#39;s Blog</title>
    <meta name="description" content="MongoDB">
    <link rel="icon" href="/favicon.ico">
    <meta name="keywords" content="MongoDB">
    <link rel="preload" href="/assets/css/0.styles.6bc9bf16.css" as="style"><link rel="preload" href="/assets/js/app.35b69267.js" as="script"><link rel="preload" href="/assets/js/63.53f087e3.js" as="script"><link rel="prefetch" href="/assets/js/10.a2f6c6ac.js"><link rel="prefetch" href="/assets/js/100.24b9a366.js"><link rel="prefetch" href="/assets/js/101.085f0585.js"><link rel="prefetch" href="/assets/js/102.66d5674f.js"><link rel="prefetch" href="/assets/js/103.7f71429c.js"><link rel="prefetch" href="/assets/js/104.13b0f535.js"><link rel="prefetch" href="/assets/js/105.0a093e85.js"><link rel="prefetch" href="/assets/js/106.a4a1db62.js"><link rel="prefetch" href="/assets/js/107.2634aacf.js"><link rel="prefetch" href="/assets/js/108.b393516d.js"><link rel="prefetch" href="/assets/js/109.769b78fb.js"><link rel="prefetch" href="/assets/js/11.fb483cc4.js"><link rel="prefetch" href="/assets/js/12.24a41994.js"><link rel="prefetch" href="/assets/js/13.a4762474.js"><link rel="prefetch" href="/assets/js/14.4a737bc9.js"><link rel="prefetch" href="/assets/js/15.548f4e99.js"><link rel="prefetch" href="/assets/js/16.b0d2654c.js"><link rel="prefetch" href="/assets/js/17.d43ab467.js"><link rel="prefetch" href="/assets/js/18.0c8f5f87.js"><link rel="prefetch" href="/assets/js/19.19ef59f8.js"><link rel="prefetch" href="/assets/js/2.436a35aa.js"><link rel="prefetch" href="/assets/js/20.24296203.js"><link rel="prefetch" href="/assets/js/21.c486888f.js"><link rel="prefetch" href="/assets/js/22.7e2305f9.js"><link rel="prefetch" href="/assets/js/23.e55bab1b.js"><link rel="prefetch" href="/assets/js/24.1468433c.js"><link rel="prefetch" href="/assets/js/25.6d82837f.js"><link rel="prefetch" href="/assets/js/26.3c4b2f18.js"><link rel="prefetch" href="/assets/js/27.21725a4f.js"><link rel="prefetch" href="/assets/js/28.db16c479.js"><link rel="prefetch" href="/assets/js/29.cb9512e5.js"><link rel="prefetch" href="/assets/js/3.5c82c0f7.js"><link rel="prefetch" href="/assets/js/30.a4c25096.js"><link rel="prefetch" href="/assets/js/31.81741530.js"><link rel="prefetch" href="/assets/js/32.da6d2ac6.js"><link rel="prefetch" href="/assets/js/33.f6164ecd.js"><link rel="prefetch" href="/assets/js/34.0344ad22.js"><link rel="prefetch" href="/assets/js/35.07d4c8d3.js"><link rel="prefetch" href="/assets/js/36.2c6adcff.js"><link rel="prefetch" href="/assets/js/37.ceb5e95e.js"><link rel="prefetch" href="/assets/js/38.d39e96e5.js"><link rel="prefetch" href="/assets/js/39.fcf34164.js"><link rel="prefetch" href="/assets/js/4.267db630.js"><link rel="prefetch" href="/assets/js/40.bdf31768.js"><link rel="prefetch" href="/assets/js/41.cc61eccd.js"><link rel="prefetch" href="/assets/js/42.042e4349.js"><link rel="prefetch" href="/assets/js/43.b385d348.js"><link rel="prefetch" href="/assets/js/44.7669f3e2.js"><link rel="prefetch" href="/assets/js/45.2fb532f4.js"><link rel="prefetch" href="/assets/js/46.0cc86442.js"><link rel="prefetch" href="/assets/js/47.30448b83.js"><link rel="prefetch" href="/assets/js/48.8893a5ed.js"><link rel="prefetch" href="/assets/js/49.ed7be1ae.js"><link rel="prefetch" href="/assets/js/5.d8a5933e.js"><link rel="prefetch" href="/assets/js/50.e4af394b.js"><link rel="prefetch" href="/assets/js/51.502ca2a7.js"><link rel="prefetch" href="/assets/js/52.f9768ea6.js"><link rel="prefetch" href="/assets/js/53.0c762369.js"><link rel="prefetch" href="/assets/js/54.dad23d00.js"><link rel="prefetch" href="/assets/js/55.4298d6a4.js"><link rel="prefetch" href="/assets/js/56.d8505fa7.js"><link rel="prefetch" href="/assets/js/57.63d197ce.js"><link rel="prefetch" href="/assets/js/58.ae9a3671.js"><link rel="prefetch" href="/assets/js/59.cb04d7cd.js"><link rel="prefetch" href="/assets/js/6.a83fef9a.js"><link rel="prefetch" href="/assets/js/60.0cedb385.js"><link rel="prefetch" href="/assets/js/61.a5c3f820.js"><link rel="prefetch" href="/assets/js/62.fc2d969d.js"><link rel="prefetch" href="/assets/js/64.9384bc9a.js"><link rel="prefetch" href="/assets/js/65.bb5db767.js"><link rel="prefetch" href="/assets/js/66.86940f42.js"><link rel="prefetch" href="/assets/js/67.37215862.js"><link rel="prefetch" href="/assets/js/68.e0c14875.js"><link rel="prefetch" href="/assets/js/69.276f0d65.js"><link rel="prefetch" href="/assets/js/7.7e7cde5e.js"><link rel="prefetch" href="/assets/js/70.0fb38ae4.js"><link rel="prefetch" href="/assets/js/71.7c824b27.js"><link rel="prefetch" href="/assets/js/72.bc39810c.js"><link rel="prefetch" href="/assets/js/73.9917d9a4.js"><link rel="prefetch" href="/assets/js/74.7912f7da.js"><link rel="prefetch" href="/assets/js/75.c193b7ec.js"><link rel="prefetch" href="/assets/js/76.ecd4e536.js"><link rel="prefetch" href="/assets/js/77.842c5aba.js"><link rel="prefetch" href="/assets/js/78.0a67366d.js"><link rel="prefetch" href="/assets/js/79.324df7d4.js"><link rel="prefetch" href="/assets/js/8.7063c274.js"><link rel="prefetch" href="/assets/js/80.68c6326b.js"><link rel="prefetch" href="/assets/js/81.a7df7b21.js"><link rel="prefetch" href="/assets/js/82.abd9c0c2.js"><link rel="prefetch" href="/assets/js/83.fd0d8457.js"><link rel="prefetch" href="/assets/js/84.148b432c.js"><link rel="prefetch" href="/assets/js/85.32148693.js"><link rel="prefetch" href="/assets/js/86.7dc5fe11.js"><link rel="prefetch" href="/assets/js/87.bd1be392.js"><link rel="prefetch" href="/assets/js/88.2c0b86aa.js"><link rel="prefetch" href="/assets/js/89.3038cc8d.js"><link rel="prefetch" href="/assets/js/9.5cab2997.js"><link rel="prefetch" href="/assets/js/90.fb4057a1.js"><link rel="prefetch" href="/assets/js/91.4aa5adaf.js"><link rel="prefetch" href="/assets/js/92.aea0a62e.js"><link rel="prefetch" href="/assets/js/93.e2d0e9a7.js"><link rel="prefetch" href="/assets/js/94.a9e33a20.js"><link rel="prefetch" href="/assets/js/95.7c55098e.js"><link rel="prefetch" href="/assets/js/96.c8dfe1c0.js"><link rel="prefetch" href="/assets/js/97.35fc7df3.js"><link rel="prefetch" href="/assets/js/98.551b3ede.js"><link rel="prefetch" href="/assets/js/99.a8f5ffc4.js">
    <link rel="stylesheet" href="/assets/css/0.styles.6bc9bf16.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div><div class="wrap"><div class="theme-container container no-sidebar"><header class="navbar"><div class="nav-header"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/logo.png" class="logo"> <span class="site-name can-hide">
        Myfun's Blog
      </span></a> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><a href="/interview/" class="nav-link">InterviewMap</a></div><div class="nav-item"><a href="https://zhangximufeng.github.io/css_tricks/" target="_blank" rel="noopener noreferrer" class="nav-link">CSS_Tricks</a></div><div class="nav-item"><a href="https://zhangximufeng.github.io/js_tricks/" target="_blank" rel="noopener noreferrer" class="nav-link">JS_Tricks</a></div><div class="nav-item"><a href="/tags/" class="nav-link">Tags</a></div><div class="nav-item"><a href="https://github.com/zhangximufeng" target="_blank" rel="noopener noreferrer" class="nav-link">Github</a></div><div class="nav-item"><a href="https://zhangximufeng.github.io/animate_resume_ts/" target="_blank" rel="noopener noreferrer" class="nav-link">About</a></div> <!----></nav> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div></div></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><a href="/interview/" class="nav-link">InterviewMap</a></div><div class="nav-item"><a href="https://zhangximufeng.github.io/css_tricks/" target="_blank" rel="noopener noreferrer" class="nav-link">CSS_Tricks</a></div><div class="nav-item"><a href="https://zhangximufeng.github.io/js_tricks/" target="_blank" rel="noopener noreferrer" class="nav-link">JS_Tricks</a></div><div class="nav-item"><a href="/tags/" class="nav-link">Tags</a></div><div class="nav-item"><a href="https://github.com/zhangximufeng" target="_blank" rel="noopener noreferrer" class="nav-link">Github</a></div><div class="nav-item"><a href="https://zhangximufeng.github.io/animate_resume_ts/" target="_blank" rel="noopener noreferrer" class="nav-link">About</a></div> <!----></nav> <!----></div> <div class="page-container"><div><div class="page card"><div class="content-header"><!----> <span class="page-timestamp">2018-09-29</span></div> <div class="content"><p></p><div class="table-of-contents"><ul><li><a href="#主从复制">主从复制</a><ul><li><a href="#_2-副本集-t52-副本集">2\. 副本集 #</a></li><li><a href="#_3-分片-t133-分片">3\. 分片 #</a></li><li><a href="#_4-参考-t234-参考">4\. 参考 #</a></li></ul></li></ul></div><p></p> <h1 id="主从复制"><a href="#主从复制" aria-hidden="true" class="header-anchor">#</a> 主从复制</h1> <hr> <p>主从复制是一个简单的数据库同步备份的集群技术</p> <ul><li>在数据库集群中要明确知道谁是主服务器，主服务器只有一台</li> <li>从服务器要知道自己的数据源也就是知道自己的主服务器是谁</li> <li>--master用来确定主服务器，--slave和--source 来控制从服务器</li></ul> <p><img src="assets/masterslave.jpg" alt="masterslave"></p> <h3 id="_1-1-主服务器-t11-1-主服务器"><a href="#_1-1-主服务器-t11-1-主服务器" aria-hidden="true" class="header-anchor">#</a> 1.1 主服务器 [#](#t11.1 主服务器)</h3> <p>master.conf</p> <div class="language-bash extra-class"><pre class="language-bash"><code>dbpath<span class="token operator">=</span>E:\ms\master
port<span class="token operator">=</span>1000
master<span class="token operator">=</span>true
</code></pre></div><p>master.bat</p> <div class="language-bash extra-class"><pre class="language-bash"><code>mongod --config master.conf
</code></pre></div><h3 id="_1-2-从服务器-t21-2-从服务器"><a href="#_1-2-从服务器-t21-2-从服务器" aria-hidden="true" class="header-anchor">#</a> 1.2 从服务器 [#](#t21.2 从服务器)</h3> <p>slave.conf</p> <div class="language-bash extra-class"><pre class="language-bash"><code>dbpath<span class="token operator">=</span>E:\p\slave
port<span class="token operator">=</span>1001
slave<span class="token operator">=</span>true
source<span class="token operator">=</span>127.0.0.1:1000
</code></pre></div><p>slave.bat</p> <div class="language-js extra-class"><pre class="language-js"><code>mongod <span class="token operator">--</span>config slave<span class="token punctuation">.</span>conf
rs<span class="token punctuation">.</span><span class="token function">slaveOk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="_1-3-主从复制的其它设置项-t31-3-主从复制的其它设置项"><a href="#_1-3-主从复制的其它设置项-t31-3-主从复制的其它设置项" aria-hidden="true" class="header-anchor">#</a> 1.3 主从复制的其它设置项 [#](#t31.3 主从复制的其它设置项)</h3> <ul><li>-only 从节点-&gt; 指定复制某个数据库默认是复制全部数据库</li> <li>-slavedelay 从节点-&gt; 设置主数据库同步数据的延迟(单位是秒)</li> <li>-fastsync 从节点-&gt; 以主数据库的节点快照为节点启动从数据库</li> <li>-autoresync 从节点-&gt;如果不同步则重新同步数据库</li> <li>-oplogSize 主节点-&gt;设置oplog的大小(主节点操作记录存储到local的oplog中)</li></ul> <h3 id="_1-4-利用shell动态添加和删除主节点-t41-4-利用shell动态添加和删除主节点"><a href="#_1-4-利用shell动态添加和删除主节点-t41-4-利用shell动态添加和删除主节点" aria-hidden="true" class="header-anchor">#</a> 1.4 利用shell动态添加和删除主节点 [#](#t41.4 利用shell动态添加和删除主节点)</h3> <p>登录从服务器</p> <div class="language-js extra-class"><pre class="language-js"><code>use local<span class="token punctuation">;</span>
show collections<span class="token punctuation">;</span>
db<span class="token punctuation">.</span>sources<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//{  &quot;host&quot; : &quot;127.0.0.1:8000&quot;, &quot;source&quot; : &quot;main&quot;, &quot;syncedTo&quot; : Timestamp(1524728329, 1) }</span>
db<span class="token punctuation">.</span>sources<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token punctuation">{</span>host<span class="token punctuation">:</span><span class="token string">'127.0.0.1:8000'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//挂载主节点</span>
db<span class="token punctuation">.</span>sources<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">{</span>host<span class="token punctuation">:</span><span class="token string">'127.0.0.1:8000'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//删除已经挂载的主节点</span>
</code></pre></div><h2 id="_2-副本集-t52-副本集"><a href="#_2-副本集-t52-副本集" aria-hidden="true" class="header-anchor">#</a> 2. 副本集 [#](#t52. 副本集)</h2> <ul><li>MongoDB复制是将数据同步在多个服务器的过程。</li> <li>复制提供了数据的冗余备份，并在多个服务器上存储数据副本，提高了数据的可用性， 并可以保证数据的安全性。</li> <li>复制还允许您从硬件故障和服务中断中恢复数据。</li></ul> <h3 id="_2-1-mongodb复制原理-t62-1-mongodb复制原理"><a href="#_2-1-mongodb复制原理-t62-1-mongodb复制原理" aria-hidden="true" class="header-anchor">#</a> 2.1 MongoDB复制原理 [#](#t62.1 MongoDB复制原理)</h3> <ul><li><p>mongodb的复制至少需要两个节点。其中一个是主节点，负责处理客户端请求，其余的都是从节点，负责复制主节点上的数据。</p></li> <li><p>mongodb各个节点常见的搭配方式为：一主一从、一主多从。</p></li> <li><p>主节点记录在其上的所有操作oplog，从节点定期轮询主节点获取这些操作，然后对自己的数据副本执行这些操作，从而保证从节点的数据与主节点一致。</p> <p><img src="assets/replication.png" alt="replication"></p></li></ul> <h3 id="_2-1-流程-t72-1-流程"><a href="#_2-1-流程-t72-1-流程" aria-hidden="true" class="header-anchor">#</a> 2.1 流程 [#](#t72.1 流程)</h3> <ol><li>一台活跃服务器和二个备份服务器</li> <li>当活跃服务器出现故障，这时集群根据权重算法推选出出活跃服务器</li> <li>当原来的主服务器恢复后又会变成从服务器</li></ol> <h3 id="_2-2-配置副本集-t82-2-配置副本集"><a href="#_2-2-配置副本集-t82-2-配置副本集" aria-hidden="true" class="header-anchor">#</a> 2.2 配置副本集 [#](#t82.2 配置副本集)</h3> <p>A服务器</p> <div class="language-bash extra-class"><pre class="language-bash"><code>dbpath<span class="token operator">=</span>E:\repl\repl1
port<span class="token operator">=</span>2001
replSet<span class="token operator">=</span>group
</code></pre></div><p>B服务器</p> <div class="language-bash extra-class"><pre class="language-bash"><code>dbpath<span class="token operator">=</span>E:\repl\repl2
port<span class="token operator">=</span>2002
replSet<span class="token operator">=</span>group
</code></pre></div><p>C服务器</p> <div class="language-bash extra-class"><pre class="language-bash"><code>dbpath<span class="token operator">=</span>E:\repl\repl3
port<span class="token operator">=</span>2003
replSet<span class="token operator">=</span>group
</code></pre></div><h3 id="_2-3-初始化副本集-t92-3-初始化副本集"><a href="#_2-3-初始化副本集-t92-3-初始化副本集" aria-hidden="true" class="header-anchor">#</a> 2.3 初始化副本集 [#](#t92.3 初始化副本集)</h3> <ul><li><p>rs.initiate() 启动一个新的副本集</p></li> <li><p>rs.conf() 查看副本集的配置</p></li> <li><p>rs.status() 命令</p> <div class="language-js extra-class"><pre class="language-js"><code>use admin<span class="token punctuation">;</span>
<span class="token keyword">var</span> conf<span class="token operator">=</span>
<span class="token punctuation">{</span>
    <span class="token string">&quot;_id&quot;</span> <span class="token punctuation">:</span> <span class="token string">&quot;group&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;members&quot;</span> <span class="token punctuation">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span> <span class="token string">&quot;_id&quot;</span> <span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>  <span class="token string">&quot;host&quot;</span> <span class="token punctuation">:</span> <span class="token string">&quot;127.0.0.1:2001&quot;</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span> <span class="token string">&quot;_id&quot;</span> <span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>  <span class="token string">&quot;host&quot;</span> <span class="token punctuation">:</span> <span class="token string">&quot;127.0.0.1:2002&quot;</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span> <span class="token string">&quot;_id&quot;</span> <span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>  <span class="token string">&quot;host&quot;</span> <span class="token punctuation">:</span> <span class="token string">&quot;127.0.0.1:2003&quot;</span>  <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
rs<span class="token punctuation">.</span><span class="token function">initiate</span><span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token punctuation">;</span>
rs<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></li></ul> <h3 id="_2-4-高级参数-t102-4-高级参数"><a href="#_2-4-高级参数-t102-4-高级参数" aria-hidden="true" class="header-anchor">#</a> 2.4 高级参数 [#](#t102.4 高级参数)</h3> <ul><li>standard 常规节点 参与投票有可能成为活跃节点</li> <li>passive 副本节点 参与投票，但不能成为活跃节点</li> <li>arbiter 仲裁节点 只参与投票，不复制节点，也不能成为活跃节点</li> <li>priority 0到1000之间，0代表是副本节点，1到1000是常规节点</li> <li>arbiterOnly:true 仲裁节点</li></ul> <h3 id="_2-5-读写分离操作-t112-5-读写分离操作"><a href="#_2-5-读写分离操作-t112-5-读写分离操作" aria-hidden="true" class="header-anchor">#</a> 2.5 读写分离操作 [#](#t112.5 读写分离操作)</h3> <p>一般情况下作为副本节点是不能进行数据库操作的，但是在读取密集的系统中读写分离是必要的</p> <pre><code> rs.slaveOk();
</code></pre> <h3 id="_2-6-oplog-t122-6-oplog"><a href="#_2-6-oplog-t122-6-oplog" aria-hidden="true" class="header-anchor">#</a> 2.6 Oplog [#](#t122.6 Oplog)</h3> <p>它被存储在本地数据库local中，会记录每一个操作。 如果希望在故障恢复的时候尽可能更多，可以把这个size设置的大一点</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token operator">--</span>oplogSize <span class="token number">1024</span>
use local<span class="token punctuation">;</span>
 db<span class="token punctuation">.</span>oplog<span class="token punctuation">.</span>rs<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="_3-分片-t133-分片"><a href="#_3-分片-t133-分片" aria-hidden="true" class="header-anchor">#</a> 3. 分片 [#](#t133. 分片)</h2> <p>在Mongodb里面存在另一种集群，就是分片技术,可以满足MongoDB数据量大量增长的需求。 当MongoDB存储海量的数据时，一台机器可能不足以存储数据，也可能不足以提供可接受的读写吞吐量。这时，我们就可以通过在多台机器上分割数据，使得数据库系统能存储和处理更多的数据。</p> <h3 id="_3-1-分片架构图-t143-1-分片架构图"><a href="#_3-1-分片架构图-t143-1-分片架构图" aria-hidden="true" class="header-anchor">#</a> 3.1 分片架构图 [#](#t143.1 分片架构图)</h3> <p><img src="assets/sharding.png" alt="sharding"></p> <h3 id="_3-2-片键-t153-2-片键"><a href="#_3-2-片键-t153-2-片键" aria-hidden="true" class="header-anchor">#</a> 3.2 片键 [#](#t153.2 片键)</h3> <p>路由根据片键把不同的文档保存到不同的分片中</p> <h3 id="_3-3-分片的应用场景-t163-3-分片的应用场景"><a href="#_3-3-分片的应用场景-t163-3-分片的应用场景" aria-hidden="true" class="header-anchor">#</a> 3.3 分片的应用场景 [#](#t163.3  分片的应用场景)</h3> <ol><li>单台机器无法存储</li> <li>单台机器已经不能满足高并发操作</li> <li>想把尽可能多的数据存放到内存中提高性能</li></ol> <h3 id="_3-4-配置-t173-4-配置"><a href="#_3-4-配置-t173-4-配置" aria-hidden="true" class="header-anchor">#</a> 3.4 配置 [#](#t173.4  配置)</h3> <h4 id="_3-4-1-创建sharding副本集-t183-4-1-创建sharding副本集"><a href="#_3-4-1-创建sharding副本集-t183-4-1-创建sharding副本集" aria-hidden="true" class="header-anchor">#</a> 3.4.1 创建Sharding副本集 [#](#t183.4.1 创建Sharding副本集)</h4> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">mkdir</span> E:\repl\db2001
mongod --port 2001 --dbpath<span class="token operator">=</span>/data/db2001  --shardsvr --replSet<span class="token operator">=</span>shard1
<span class="token function">mkdir</span> E:\repl/db2002
mongod --port 2002 --dbpath<span class="token operator">=</span>/data/db2002 --shardsvr --replSet<span class="token operator">=</span>shard1
</code></pre></div><div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># mongo localhost:2001</span>
rs.initiate<span class="token punctuation">(</span><span class="token punctuation">{</span>_id: <span class="token string">'shard1'</span>, members: <span class="token punctuation">[</span><span class="token punctuation">{</span>_id: 0, host: <span class="token string">'localhost:2001'</span><span class="token punctuation">}</span>, <span class="token punctuation">{</span>_id: 1, host: <span class="token string">'localhost:2002'</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
rs.isMaster<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">#查看主从关系</span>
</code></pre></div><div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">mkdir</span> E:\repl\db2003
mongod --port 2003 --dbpath<span class="token operator">=</span>E:\repl\db2003  --shardsvr --replSet<span class="token operator">=</span>shard2
<span class="token function">mkdir</span> E:\repl\db2004
mongod --port 2004 --dbpath<span class="token operator">=</span>E:\repl\db2004 --shardsvr --replSet<span class="token operator">=</span>shard2
</code></pre></div><div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># mongo localhost:2003</span>
rs.initiate<span class="token punctuation">(</span><span class="token punctuation">{</span>_id: <span class="token string">'shard2'</span>, members: <span class="token punctuation">[</span><span class="token punctuation">{</span>_id: 0, host: <span class="token string">'localhost:2003'</span><span class="token punctuation">}</span>, <span class="token punctuation">{</span>_id: 1, host: <span class="token string">'localhost:2004'</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
rs.isMaster<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">#查看主从关系</span>
</code></pre></div><h4 id="_3-4-2-创建一个配置服务器-t193-4-2-创建一个配置服务器"><a href="#_3-4-2-创建一个配置服务器-t193-4-2-创建一个配置服务器" aria-hidden="true" class="header-anchor">#</a> 3.4.2 创建一个配置服务器 [#](#t193.4.2 创建一个配置服务器)</h4> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">mkdir</span> E:\repl\db2005
mongod --port 2005 --dbpath<span class="token operator">=</span>E:\repl\db2005  --shardsvr --replSet<span class="token operator">=</span>config
<span class="token function">mkdir</span> E:\repl\db2006
mongod --port 2006 --dbpath<span class="token operator">=</span>E:\repl\db2006  --shardsvr --replSet<span class="token operator">=</span>config
</code></pre></div><div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># mongo localhost:2005</span>
rs.initiate<span class="token punctuation">(</span><span class="token punctuation">{</span>_id: <span class="token string">'config'</span>, members: <span class="token punctuation">[</span><span class="token punctuation">{</span>_id: 0, host: <span class="token string">'localhost:2005'</span><span class="token punctuation">}</span>, <span class="token punctuation">{</span>_id: 1, host: <span class="token string">'localhost:2006'</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
rs.isMaster<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">#查看主从关系</span>
</code></pre></div><h4 id="_3-4-2-创建路由服务器，并且连接配置服务器-t203-4-2-创建路由服务器，并且连接配置服务器"><a href="#_3-4-2-创建路由服务器，并且连接配置服务器-t203-4-2-创建路由服务器，并且连接配置服务器" aria-hidden="true" class="header-anchor">#</a> 3.4.2 创建路由服务器，并且连接配置服务器 [#](#t203.4.2 创建路由服务器，并且连接配置服务器)</h4> <p>路由器调用mongos命令</p> <div class="language-bash extra-class"><pre class="language-bash"><code>mongos --port 2006 --configdb config/localhost:2005,localhost:2006
</code></pre></div><h4 id="_3-4-3-添加分片数据库-t213-4-3-添加分片数据库"><a href="#_3-4-3-添加分片数据库-t213-4-3-添加分片数据库" aria-hidden="true" class="header-anchor">#</a> 3.4.3 添加分片数据库 [#](#t213.4.3 添加分片数据库)</h4> <div class="language-bash extra-class"><pre class="language-bash"><code>mongo localhost:2006
use admin
<span class="token operator">&gt;</span> db.runCommand<span class="token punctuation">(</span><span class="token punctuation">{</span> addshard: <span class="token string">'shard1/localhost:2001,localhost:2002'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token operator">&gt;</span> db.runCommand<span class="token punctuation">(</span><span class="token punctuation">{</span> addshard: <span class="token string">'shard2/localhost:2003,localhost:2004'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="_3-4-5-在路由服务器打开数据分片功能-t223-4-5-在路由服务器打开数据分片功能"><a href="#_3-4-5-在路由服务器打开数据分片功能-t223-4-5-在路由服务器打开数据分片功能" aria-hidden="true" class="header-anchor">#</a> 3.4.5 在路由服务器打开数据分片功能 [#](#t223.4.5 在路由服务器打开数据分片功能)</h4> <div class="language-bash extra-class"><pre class="language-bash"><code>use admin<span class="token punctuation">;</span>
<span class="token operator">&gt;</span> db.runCommand<span class="token punctuation">(</span><span class="token punctuation">{</span> enablesharding: <span class="token string">'school'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token operator">&gt;</span> db.runCommand<span class="token punctuation">(</span><span class="token punctuation">{</span> shardcollection: <span class="token string">'school.students'</span>, key: <span class="token punctuation">{</span>name: 1<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="_4-参考-t234-参考"><a href="#_4-参考-t234-参考" aria-hidden="true" class="header-anchor">#</a> 4. 参考 [#](#t234. 参考)</h2> <ul><li><a href="https://docs.mongodb.com/manual/reference/configuration-options/" target="_blank" rel="noopener noreferrer">configuration-options<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div> <!----> <div class="content page-nav"><p class="inner"><span class="prev">
          ← <a href="/fe/29.mongodb-3.html" class="prev">
            索引
          </a></span> <span class="next"><a href="/fe/29.mongodb-5.html">
            MongoDB简介
          </a> →
        </span></p></div> <div id="comment-container"><div class="gt-container"><div class="gt-initing"><i class="gt-loader"></i> <p class="gt-initing-text">Gitalking ...</p></div> <!----> <!----> <div><div class="gt-header"><a class="gt-avatar-github"><span class="gt-ico gt-ico-github"><span class="gt-svg"><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <path d="M64 524C64 719.602 189.356 885.926 364.113 947.017 387.65799 953 384 936.115 384 924.767L384 847.107C248.118 863.007 242.674 773.052 233.5 758.001 215 726.501 171.5 718.501 184.5 703.501 215.5 687.501 247 707.501 283.5 761.501 309.956 800.642 361.366 794.075 387.658 787.497 393.403 763.997 405.637 743.042 422.353 726.638 281.774 701.609 223 615.67 223 513.5 223 464.053 239.322 418.406 271.465 381.627 251.142 320.928 273.421 269.19 276.337 261.415 334.458 256.131 394.888 302.993 399.549 306.685 432.663 297.835 470.341 293 512.5 293 554.924 293 592.81 297.896 626.075 306.853 637.426 298.219 693.46 258.054 747.5 262.966 750.382 270.652 772.185 321.292 753.058 381.083 785.516 417.956 802 463.809 802 513.5 802 615.874 742.99 701.953 601.803 726.786 625.381 750.003 640 782.295 640 818.008L640 930.653C640.752 939.626 640 948.664978 655.086 948.665 832.344 888.962 960 721.389 960 524 960 276.576 759.424 76 512 76 264.577 76 64 276.576 64 524Z"></path>
</svg>
</span> <!----></span></a> <div class="gt-header-comment"><textarea placeholder="Leave a comment" class="gt-header-textarea"></textarea> <div class="gt-header-preview markdown-body hide"></div> <div class="gt-header-controls"><a href="https://guides.github.com/features/mastering-markdown/" target="_blank" class="gt-header-controls-tip"><span class="gt-ico gt-ico-tip"><span class="gt-svg"><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <path d="M512 366.949535c-16.065554 0-29.982212 13.405016-29.982212 29.879884l0 359.070251c0 16.167882 13.405016 29.879884 29.982212 29.879884 15.963226 0 29.879884-13.405016 29.879884-29.879884L541.879884 396.829419C541.879884 380.763865 528.474868 366.949535 512 366.949535L512 366.949535z"
    p-id="3083"></path>
  <path d="M482.017788 287.645048c0-7.776956 3.274508-15.553912 8.80024-21.181973 5.525732-5.525732 13.302688-8.80024 21.181973-8.80024 7.776956 0 15.553912 3.274508 21.079644 8.80024 5.525732 5.62806 8.80024 13.405016 8.80024 21.181973 0 7.776956-3.274508 15.656241-8.80024 21.181973-5.525732 5.525732-13.405016 8.697911-21.079644 8.697911-7.879285 0-15.656241-3.274508-21.181973-8.697911C485.292295 303.301289 482.017788 295.524333 482.017788 287.645048L482.017788 287.645048z"
    p-id="3084"></path>
  <path d="M512 946.844409c-239.8577 0-434.895573-195.037873-434.895573-434.895573 0-239.8577 195.037873-434.895573 434.895573-434.895573 239.755371 0 434.895573 195.037873 434.895573 434.895573C946.895573 751.806535 751.755371 946.844409 512 946.844409zM512 126.17088c-212.740682 0-385.880284 173.037274-385.880284 385.777955 0 212.740682 173.037274 385.777955 385.880284 385.777955 212.740682 0 385.777955-173.037274 385.777955-385.777955C897.777955 299.208154 724.740682 126.17088 512 126.17088z"
    p-id="3085"></path>
</svg>
</span> <span class="gt-ico-text">Markdown is supported</span></span></a> <!----> <button class="gt-btn gt-btn-preview"><span class="gt-btn-text">Preview</span> <!----></button> <button class="gt-btn gt-btn-login"><span class="gt-btn-text">Login with GitHub</span> <!----></button></div></div></div> <div class="gt-comments"><span></span> <p class="gt-comments-null">
                Be the first guy leaving a comment!
            </p> <!----></div></div></div></div></div></div> <!----></div> <div class="tool-group"><!----></div></div> <!----></div> <div class="background-mask" style="background:#f6f6f6;"></div></div></div>
    <script src="/assets/js/app.35b69267.js" defer></script><script src="/assets/js/63.53f087e3.js" defer></script>
  </body>
</html>
