<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>http通信有什么问题? | Myfun&#39;s Blog</title>
    <meta name="description" content="http">
    <link rel="icon" href="/favicon.ico">
    <meta name="keywords" content="http">
    <link rel="preload" href="/assets/css/0.styles.6bc9bf16.css" as="style"><link rel="preload" href="/assets/js/app.35b69267.js" as="script"><link rel="preload" href="/assets/js/31.81741530.js" as="script"><link rel="prefetch" href="/assets/js/10.a2f6c6ac.js"><link rel="prefetch" href="/assets/js/100.24b9a366.js"><link rel="prefetch" href="/assets/js/101.085f0585.js"><link rel="prefetch" href="/assets/js/102.66d5674f.js"><link rel="prefetch" href="/assets/js/103.7f71429c.js"><link rel="prefetch" href="/assets/js/104.13b0f535.js"><link rel="prefetch" href="/assets/js/105.0a093e85.js"><link rel="prefetch" href="/assets/js/106.a4a1db62.js"><link rel="prefetch" href="/assets/js/107.2634aacf.js"><link rel="prefetch" href="/assets/js/108.b393516d.js"><link rel="prefetch" href="/assets/js/109.769b78fb.js"><link rel="prefetch" href="/assets/js/11.fb483cc4.js"><link rel="prefetch" href="/assets/js/12.24a41994.js"><link rel="prefetch" href="/assets/js/13.a4762474.js"><link rel="prefetch" href="/assets/js/14.4a737bc9.js"><link rel="prefetch" href="/assets/js/15.548f4e99.js"><link rel="prefetch" href="/assets/js/16.b0d2654c.js"><link rel="prefetch" href="/assets/js/17.d43ab467.js"><link rel="prefetch" href="/assets/js/18.0c8f5f87.js"><link rel="prefetch" href="/assets/js/19.19ef59f8.js"><link rel="prefetch" href="/assets/js/2.436a35aa.js"><link rel="prefetch" href="/assets/js/20.24296203.js"><link rel="prefetch" href="/assets/js/21.c486888f.js"><link rel="prefetch" href="/assets/js/22.7e2305f9.js"><link rel="prefetch" href="/assets/js/23.e55bab1b.js"><link rel="prefetch" href="/assets/js/24.1468433c.js"><link rel="prefetch" href="/assets/js/25.6d82837f.js"><link rel="prefetch" href="/assets/js/26.3c4b2f18.js"><link rel="prefetch" href="/assets/js/27.21725a4f.js"><link rel="prefetch" href="/assets/js/28.db16c479.js"><link rel="prefetch" href="/assets/js/29.cb9512e5.js"><link rel="prefetch" href="/assets/js/3.5c82c0f7.js"><link rel="prefetch" href="/assets/js/30.a4c25096.js"><link rel="prefetch" href="/assets/js/32.da6d2ac6.js"><link rel="prefetch" href="/assets/js/33.f6164ecd.js"><link rel="prefetch" href="/assets/js/34.0344ad22.js"><link rel="prefetch" href="/assets/js/35.07d4c8d3.js"><link rel="prefetch" href="/assets/js/36.2c6adcff.js"><link rel="prefetch" href="/assets/js/37.ceb5e95e.js"><link rel="prefetch" href="/assets/js/38.d39e96e5.js"><link rel="prefetch" href="/assets/js/39.fcf34164.js"><link rel="prefetch" href="/assets/js/4.267db630.js"><link rel="prefetch" href="/assets/js/40.bdf31768.js"><link rel="prefetch" href="/assets/js/41.cc61eccd.js"><link rel="prefetch" href="/assets/js/42.042e4349.js"><link rel="prefetch" href="/assets/js/43.b385d348.js"><link rel="prefetch" href="/assets/js/44.7669f3e2.js"><link rel="prefetch" href="/assets/js/45.2fb532f4.js"><link rel="prefetch" href="/assets/js/46.0cc86442.js"><link rel="prefetch" href="/assets/js/47.30448b83.js"><link rel="prefetch" href="/assets/js/48.8893a5ed.js"><link rel="prefetch" href="/assets/js/49.ed7be1ae.js"><link rel="prefetch" href="/assets/js/5.d8a5933e.js"><link rel="prefetch" href="/assets/js/50.e4af394b.js"><link rel="prefetch" href="/assets/js/51.502ca2a7.js"><link rel="prefetch" href="/assets/js/52.f9768ea6.js"><link rel="prefetch" href="/assets/js/53.0c762369.js"><link rel="prefetch" href="/assets/js/54.dad23d00.js"><link rel="prefetch" href="/assets/js/55.4298d6a4.js"><link rel="prefetch" href="/assets/js/56.d8505fa7.js"><link rel="prefetch" href="/assets/js/57.63d197ce.js"><link rel="prefetch" href="/assets/js/58.ae9a3671.js"><link rel="prefetch" href="/assets/js/59.cb04d7cd.js"><link rel="prefetch" href="/assets/js/6.a83fef9a.js"><link rel="prefetch" href="/assets/js/60.0cedb385.js"><link rel="prefetch" href="/assets/js/61.a5c3f820.js"><link rel="prefetch" href="/assets/js/62.fc2d969d.js"><link rel="prefetch" href="/assets/js/63.53f087e3.js"><link rel="prefetch" href="/assets/js/64.9384bc9a.js"><link rel="prefetch" href="/assets/js/65.bb5db767.js"><link rel="prefetch" href="/assets/js/66.86940f42.js"><link rel="prefetch" href="/assets/js/67.37215862.js"><link rel="prefetch" href="/assets/js/68.e0c14875.js"><link rel="prefetch" href="/assets/js/69.276f0d65.js"><link rel="prefetch" href="/assets/js/7.7e7cde5e.js"><link rel="prefetch" href="/assets/js/70.0fb38ae4.js"><link rel="prefetch" href="/assets/js/71.7c824b27.js"><link rel="prefetch" href="/assets/js/72.bc39810c.js"><link rel="prefetch" href="/assets/js/73.9917d9a4.js"><link rel="prefetch" href="/assets/js/74.7912f7da.js"><link rel="prefetch" href="/assets/js/75.c193b7ec.js"><link rel="prefetch" href="/assets/js/76.ecd4e536.js"><link rel="prefetch" href="/assets/js/77.842c5aba.js"><link rel="prefetch" href="/assets/js/78.0a67366d.js"><link rel="prefetch" href="/assets/js/79.324df7d4.js"><link rel="prefetch" href="/assets/js/8.7063c274.js"><link rel="prefetch" href="/assets/js/80.68c6326b.js"><link rel="prefetch" href="/assets/js/81.a7df7b21.js"><link rel="prefetch" href="/assets/js/82.abd9c0c2.js"><link rel="prefetch" href="/assets/js/83.fd0d8457.js"><link rel="prefetch" href="/assets/js/84.148b432c.js"><link rel="prefetch" href="/assets/js/85.32148693.js"><link rel="prefetch" href="/assets/js/86.7dc5fe11.js"><link rel="prefetch" href="/assets/js/87.bd1be392.js"><link rel="prefetch" href="/assets/js/88.2c0b86aa.js"><link rel="prefetch" href="/assets/js/89.3038cc8d.js"><link rel="prefetch" href="/assets/js/9.5cab2997.js"><link rel="prefetch" href="/assets/js/90.fb4057a1.js"><link rel="prefetch" href="/assets/js/91.4aa5adaf.js"><link rel="prefetch" href="/assets/js/92.aea0a62e.js"><link rel="prefetch" href="/assets/js/93.e2d0e9a7.js"><link rel="prefetch" href="/assets/js/94.a9e33a20.js"><link rel="prefetch" href="/assets/js/95.7c55098e.js"><link rel="prefetch" href="/assets/js/96.c8dfe1c0.js"><link rel="prefetch" href="/assets/js/97.35fc7df3.js"><link rel="prefetch" href="/assets/js/98.551b3ede.js"><link rel="prefetch" href="/assets/js/99.a8f5ffc4.js">
    <link rel="stylesheet" href="/assets/css/0.styles.6bc9bf16.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div><div class="wrap"><div class="theme-container container no-sidebar"><header class="navbar"><div class="nav-header"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/logo.png" class="logo"> <span class="site-name can-hide">
        Myfun's Blog
      </span></a> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><a href="/interview/" class="nav-link">InterviewMap</a></div><div class="nav-item"><a href="https://zhangximufeng.github.io/css_tricks/" target="_blank" rel="noopener noreferrer" class="nav-link">CSS_Tricks</a></div><div class="nav-item"><a href="https://zhangximufeng.github.io/js_tricks/" target="_blank" rel="noopener noreferrer" class="nav-link">JS_Tricks</a></div><div class="nav-item"><a href="/tags/" class="nav-link">Tags</a></div><div class="nav-item"><a href="https://github.com/zhangximufeng" target="_blank" rel="noopener noreferrer" class="nav-link">Github</a></div><div class="nav-item"><a href="https://zhangximufeng.github.io/animate_resume_ts/" target="_blank" rel="noopener noreferrer" class="nav-link">About</a></div> <!----></nav> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div></div></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><a href="/interview/" class="nav-link">InterviewMap</a></div><div class="nav-item"><a href="https://zhangximufeng.github.io/css_tricks/" target="_blank" rel="noopener noreferrer" class="nav-link">CSS_Tricks</a></div><div class="nav-item"><a href="https://zhangximufeng.github.io/js_tricks/" target="_blank" rel="noopener noreferrer" class="nav-link">JS_Tricks</a></div><div class="nav-item"><a href="/tags/" class="nav-link">Tags</a></div><div class="nav-item"><a href="https://github.com/zhangximufeng" target="_blank" rel="noopener noreferrer" class="nav-link">Github</a></div><div class="nav-item"><a href="https://zhangximufeng.github.io/animate_resume_ts/" target="_blank" rel="noopener noreferrer" class="nav-link">About</a></div> <!----></nav> <!----></div> <div class="page-container"><div><div class="page card"><div class="content-header"><!----> <span class="page-timestamp">2018-09-29</span></div> <div class="content"><p></p><div class="table-of-contents"><ul><li><a href="#http通信有什么问题">http通信有什么问题?</a><ul><li><a href="#_2-https如何解决上述三个问题-t42-https如何解决上述三个问题">2\. HTTPS如何解决上述三个问题? #</a></li><li><a href="#_3-ssl-和-tls-的区别-t53-ssl-和-tls-的区别">3\. SSL 和 TLS 的区别 #</a></li><li><a href="#_3-ssl-协议-t63-ssl-协议">3\. SSL 协议 #</a></li><li><a href="#_3-6-https协议改进过程-t123-6-https协议改进过程">3.6 HTTPS协议改进过程 #</a></li><li><a href="#_3-6-2-安全传递密钥-t143-6-2-安全传递密钥">3.6.2 安全传递密钥 #</a></li><li><a href="#_3-7-证书-t213-7-证书">3.7 证书 #</a></li><li><a href="#_2-https服务器-t242-https服务器">2\. https服务器 #</a></li><li><a href="#_3-8-让你的网站支持https-t313-8-让你的网站支持https">3.8 让你的网站支持https #</a></li></ul></li></ul></div><p></p> <h1 id="http通信有什么问题"><a href="#http通信有什么问题" aria-hidden="true" class="header-anchor">#</a> http通信有什么问题?</h1> <hr> <ul><li>窃听 - 对称加密</li> <li>传递密钥 - 非对称加密</li> <li>安全速度 - 非对称加密+对称加密</li> <li>中间人攻击 - 证书</li> <li>证书伪造 - 消息摘要</li> <li>摘要伪造 - 数字签名</li></ul> <h3 id="_1-1-可能被窃听-t11-1-可能被窃听"><a href="#_1-1-可能被窃听-t11-1-可能被窃听" aria-hidden="true" class="header-anchor">#</a> 1.1 可能被窃听 [#](#t11.1 可能被窃听)</h3> <ul><li>HTTP 本身不具备加密的功能,HTTP 报文使用明文方式发送</li> <li>由于互联网是由联通世界各个地方的网络设施组成,所有发送和接收经过某些设备的数据都可能被截获或窥视。(例如大家都熟悉的抓包工具:Wireshark),即使经过加密处理,也会被窥视是通信内容,只是可能很难或者无法破解出报文的信息而已</li></ul> <h3 id="_1-2-认证问题-t21-2-认证问题"><a href="#_1-2-认证问题-t21-2-认证问题" aria-hidden="true" class="header-anchor">#</a> 1.2 认证问题 [#](#t21.2 认证问题)</h3> <ul><li><p>无法确认你发送到的服务器就是真正的目标服务器(可能服务器是伪装的)</p></li> <li><p>无法确定返回的客户端是否是按照真实意图接收的客户端(可能是伪装的客户端)</p></li> <li><p>无法确定正在通信的对方是否具备访问权限,Web 服务器上某些重要的信息，只想发给特定用户即使是无意义的请求也会照单全收。无法阻止海量请求下的 DoS 攻击（Denial of Service，拒绝服务攻击）。</p> <h3 id="_1-3-可能被篡改-t31-3-可能被篡改"><a href="#_1-3-可能被篡改-t31-3-可能被篡改" aria-hidden="true" class="header-anchor">#</a> 1.3 可能被篡改 [#](#t31.3 可能被篡改)</h3> <p>请求或响应在传输途中，遭攻击者拦截并篡改内容的攻击被称为中间人攻击（Man-in-the-Middle attack，MITM）。</p></li></ul> <h2 id="_2-https如何解决上述三个问题-t42-https如何解决上述三个问题"><a href="#_2-https如何解决上述三个问题-t42-https如何解决上述三个问题" aria-hidden="true" class="header-anchor">#</a> 2. HTTPS如何解决上述三个问题? [#](#t42. HTTPS如何解决上述三个问题?)</h2> <p>HTTPS是在通信接口部分用 TLS(Transport Layer Security)协议。</p> <p><img src="http://img.zhufengpeixun.cn/https1.png" alt></p> <h2 id="_3-ssl-和-tls-的区别-t53-ssl-和-tls-的区别"><a href="#_3-ssl-和-tls-的区别-t53-ssl-和-tls-的区别" aria-hidden="true" class="header-anchor">#</a> 3. SSL 和 TLS 的区别 [#](#t53. SSL 和 TLS 的区别)</h2> <ul><li>传输层安全性协议（英语：Transport Layer Security，缩写作 TLS），及其前身安全套接层（Secure Sockets Layer，缩写作 SSL）是一种安全协议，目的是为互联网通信，提供安全及数据完整性保障。</li> <li>网景公司（Netscape）在1994年推出首版网页浏览器，网景导航者时，推出HTTPS协议，以SSL进行加密，这是SSL的起源。</li> <li>IETF将SSL进行标准化，1999年公布第一版TLS标准文件。随后又公布RFC 5246 （2008年8月）与 RFC 6176 （2011年3月）。以下就简称SSL</li> <li>TLS是SSL的标准. HTTPS 就是 HTTP + SSL</li></ul> <p><img src="http://img.zhufengpeixun.cn/https_http.png" alt></p> <h2 id="_3-ssl-协议-t63-ssl-协议"><a href="#_3-ssl-协议-t63-ssl-协议" aria-hidden="true" class="header-anchor">#</a> 3. SSL 协议 [#](#t63. SSL 协议)</h2> <p>HTTPS 协议的主要功能基本都依赖于 TLS/SSL 协议，TLS/SSL 的功能实现主要依赖于三类基本算法：散列函数 、对称加密和非对称加密，其利用非对称加密实现身份认证和密钥协商，对称加密算法采用协商的密钥对数据加密，基于散列函数验证信息的完整性。</p> <p><img src="http://img.zhufengpeixun.cn/tls_ssl.png" alt></p> <h3 id="_3-1-对称加密-t73-1-对称加密"><a href="#_3-1-对称加密-t73-1-对称加密" aria-hidden="true" class="header-anchor">#</a> 3.1 对称加密 [#](#t73.1 对称加密)</h3> <ul><li>常见的有 AES-CBC、DES、3DES、AES-GCM等，相同的密钥可以用于信息的加密和解密，掌握密钥才能获取信息，能够防止信息窃听，通信方式是1对1；</li> <li>对称加密需要共享相同的密码，密码的安全是保证信息安全的基础，服务器和多 个客户端通信，需要维持多个密码记录，且缺少修改密码的机制；</li> <li>优点：算法公开、计算量小、加密速度快、加密效率高。</li> <li>缺点：交易双方都使用同样钥匙，安全性得不到保证。</li></ul> <p><img src="http://img.zhufengpeixun.cn/https2.png" alt></p> <h3 id="_3-2-非对称加密技术-t83-2-非对称加密技术"><a href="#_3-2-非对称加密技术-t83-2-非对称加密技术" aria-hidden="true" class="header-anchor">#</a> 3.2 非对称加密技术 [#](#t83.2 非对称加密技术)</h3> <ul><li>即常见的 RSA 算法，还包括 ECC、DH 等算法，算法特点是，密钥成对出现，一般称为公钥(公开)和私钥(保密)，公钥加密的信息只能私钥解开，私钥加密的信息只能公钥解开。因此掌握公钥的不同客户端之间不能互相解密信息，只能和掌握私钥的服务器进行加密通信，服务器可以实现1对多的通信，客户端也可以用来验证掌握私钥的服务器身份。</li> <li>非对称加密的特点是信息传输一对多，服务器只需要维持一个私钥就能够和多个客户端进行加密通信，但服务器发出的信息能够被所有的客户端解密，且该算法的计算复杂，加密速度慢。</li></ul> <p><img src="http://img.zhufengpeixun.cn/https3.png" alt></p> <h3 id="_3-3-完整性验证算法-t93-3-完整性验证算法"><a href="#_3-3-完整性验证算法-t93-3-完整性验证算法" aria-hidden="true" class="header-anchor">#</a> 3.3 完整性验证算法 [#](#t93.3 完整性验证算法)</h3> <ul><li>常见的有 MD5、SHA1、SHA256，该类函数特点是函数单向不可逆、对输入非常敏感、输出长度固定，针对数据的任何修改都会改变散列函数的结果，用于防止信息篡改并验证数据的完整性；</li> <li>在信息传输过程中，散列函数不能单独实现信息防篡改，因为明文传输，中间人可以修改信息之后重新计算信息摘要，因此需要对传输的信息以及信息摘要进行加密；</li></ul> <h3 id="_3-4-工作方式-t103-4-工作方式"><a href="#_3-4-工作方式-t103-4-工作方式" aria-hidden="true" class="header-anchor">#</a> 3.4 工作方式 [#](#t103.4 工作方式)</h3> <p>结合三类算法的特点，TLS 的基本工作方式是</p> <ul><li>客户端使用非对称加密与服务器进行通信，实现身份验证并协商对称加密使用的密钥</li> <li>然后对称加密算法采用协商密钥对信息以及信息摘要进行加密通信，不同的节点之间采用的对称密钥不同，从而可以保证信息只能通信双方获取。</li></ul> <h3 id="_3-5-ssl协议构成-t113-5-ssl协议构成"><a href="#_3-5-ssl协议构成-t113-5-ssl协议构成" aria-hidden="true" class="header-anchor">#</a> 3.5 SSL协议构成 [#](#t113.5 SSL协议构成)</h3> <ul><li>第一层是记录协议(Record Protocol), 用于定义传输格式。</li> <li>第二层握手协议(Handshake Protocol),它建立在SSL记录协议之上,用于在实际的数据传输开始前，通讯双方进行身份认证、协商加密算法、交换加密密钥等。</li></ul> <p><img src="http://img.zhufengpeixun.cn/ssltlsprotocal.png" alt></p> <h2 id="_3-6-https协议改进过程-t123-6-https协议改进过程"><a href="#_3-6-https协议改进过程-t123-6-https协议改进过程" aria-hidden="true" class="header-anchor">#</a> 3.6 HTTPS协议改进过程 [#](#t123.6 HTTPS协议改进过程)</h2> <h3 id="_3-6-1-针对窃听风险-t133-6-1-针对窃听风险"><a href="#_3-6-1-针对窃听风险-t133-6-1-针对窃听风险" aria-hidden="true" class="header-anchor">#</a> 3.6.1 针对窃听风险 [#](#t133.6.1 针对窃听风险)</h3> <p>黑客可以嗅探通信内容 <img src="http://img.zhufengpeixun.cn/ssltlsprotocal.png" alt></p> <p><img src="http://img.zhufengpeixun.cn/ssltlsprotocal.png" alt></p> <p>对称加密算法的特点是加密和解密是使用同一个密钥，加解密速度快，典型的对称加密算法有DES、AES等。使用对称加密，客户端和服务端双方拥有相同的密钥，信息得到安全传输。 此种方式的缺点是：</p> <ul><li>客户端、服务器双方都需要维护大量的密钥，维护成本很高；</li> <li>因每个客户端、服务器的安全级别不同，密钥容易泄露；</li></ul> <h2 id="_3-6-2-安全传递密钥-t143-6-2-安全传递密钥"><a href="#_3-6-2-安全传递密钥-t143-6-2-安全传递密钥" aria-hidden="true" class="header-anchor">#</a> 3.6.2 安全传递密钥 [#](#t143.6.2 安全传递密钥)</h2> <p>非对称加密算法的特点加密和解密分别使用不同的密钥, 相对来说加解密速度较慢，典型的非对称加密算法有RSA、DSA等。客户端用公钥对请求内容加密，服务器使用私钥对内容解密，反之亦然。 此种方式的缺点是：</p> <ul><li>公钥是公开的，所以针对私钥加密的信息，黑客截获后可以使用公钥进行解密，获取其中的内容；</li> <li>公钥并不包含服务器的信息，使用非对称加密算法无法确保服务器身份的合法性，存在中间人攻击的风险，服务器发送给客户端的公钥可能在传送过程中被中间人截获并篡改；</li> <li>使用非对称加密在数据加密解密过程需要消耗一定时间，降低了数据传输效率；</li></ul> <p>客户端C和服务器S进行通信，中间节点M截获了二者的通信； 节点M自己计算产生一对公钥pub_M和私钥 pri_M； C向S请求公钥时，M把自己的公钥pub_M发给了C； C 使用公钥pub_M加密的数据能够被M解密，因为M掌握对应的私钥 pri_M，而 C 无法根据公钥信息判断服务器的身份，从而 C 和 M 之间建立了“可信”加密连接; 中间节点 M 和服务器S之间再建立合法的连接，因此 C 和 S 之间通信被M完全掌握，M 可以进行信息的窃听、篡改等操作。</p> <h3 id="_3-6-ssl密钥协商的过程如下-t153-6-ssl密钥协商的过程如下"><a href="#_3-6-ssl密钥协商的过程如下-t153-6-ssl密钥协商的过程如下" aria-hidden="true" class="header-anchor">#</a> 3.6 SSL密钥协商的过程如下 [#](#t153.6 SSL密钥协商的过程如下)</h3> <h4 id="_3-6-1-client-hello过程-t163-6-1-client-hello过程"><a href="#_3-6-1-client-hello过程-t163-6-1-client-hello过程" aria-hidden="true" class="header-anchor">#</a> 3.6.1. client_hello过程 [#](#t163.6.1. client_hello过程)</h4> <p>客户端发起请求，以明文传输请求信息，包含版本信息，加密套件候选列表，压缩算法候选列表，随机数，扩展字段等信息，相关信息如下：</p> <p><img src="http://img.zhufengpeixun.cn/https_ssl.svg" alt></p> <ul><li>版本信息: 支持的最高TSL协议版本version，从低到高依次 SSLv2 SSLv3 TLSv1 TLSv1.1 TLSv1.2，当前基本不再使用低于 TLSv1 的版本</li> <li>加密套件候选列表(cipher suite): 认证算法 Au (身份验证)、密钥交换算法 KeyExchange(密钥协商)、对称加密算法 Enc (信息加密)和信息摘要 Mac(完整性校验);</li> <li>压缩算法候选列表:支持的压缩算法 compression methods 列表，用于后续的信息压缩传输;</li> <li>随机数:随机数就是上图里的RNc,用于后续生成协商密钥;</li> <li>协商数据:支持协议与算法的相关参数以及其它辅助信息等，常见的 SNI 就属于扩展字段，后续单独讨论该字段作用。</li></ul> <h4 id="_3-6-2-server-hello-过程-t173-6-2-server-hello-过程"><a href="#_3-6-2-server-hello-过程-t173-6-2-server-hello-过程" aria-hidden="true" class="header-anchor">#</a> 3.6.2. server_hello 过程 [#](#t173.6.2. server_hello 过程)</h4> <ul><li>服务端返回协商的信息结果，包括选择使用的协议版本version，选择的加密套件 cipher suite，选择的压缩算法 compression method、随机数 RNs等，其中随机数用于后续的密钥协商;</li> <li>服务器证书链,用于身份校验和密钥交换</li> <li>通知客户端server-hello结束,请求客户端的证书和密钥</li></ul> <h4 id="_3-6-3-证书校验，协商最后通信密钥-t183-6-3-证书校验，协商最后通信密钥"><a href="#_3-6-3-证书校验，协商最后通信密钥-t183-6-3-证书校验，协商最后通信密钥" aria-hidden="true" class="header-anchor">#</a> 3.6.3. 证书校验，协商最后通信密钥 [#](#t183.6.3. 证书校验，协商最后通信密钥)</h4> <p>a. 客户端验证服务端证书的合法性，如果验证通过才会进行后续通信，否则根据错误情况不同做出提示和操作，合法性验证包括如下：</p> <ul><li>证书链的可信性 trusted certificate path</li> <li>证书是否吊销 revocation</li> <li>有效期 expiry date，证书是否在有效时间范围;</li> <li>域名 domain，核查证书域名是否与当前的访问域名匹配，匹配规则后续分析; b. 客户端发送客户端证书,公钥服务端验证(过程同客户端验证) c. 客户端hash所有之前的消息,发送hash值和摘要,用客户端的私钥加密发送给服务端,服务端用客户端的公钥解密,验证了服务端获取的客户端的公钥和算法是正确的 d. 客户端生成pms,用服务端的公钥加密后发送给服务端 e. 客户端和服务端同时计算出最终会话密钥(MS)</li></ul> <h4 id="_3-6-4-验证协商密钥-t193-6-4-验证协商密钥"><a href="#_3-6-4-验证协商密钥-t193-6-4-验证协商密钥" aria-hidden="true" class="header-anchor">#</a> 3.6.4. 验证协商密钥 [#](#t193.6.4. 验证协商密钥)</h4> <p>a. Client发送ChangeCipherSpec，指示Server从现在开始发送的消息都是加密过的 b. Client发送Finishd，包含了前面所有握手消息的hash，可以让server验证握手过程是否被第三方篡改 c. 服务端发送ChangeCipherSpec，指示Client从现在开始发送的消息都是加密过的 d. Server发送Finishd，包含了前面所有握手消息的hash，可以让client验证握手过程是否被第三方篡改，并且证明自己是Certificate密钥的拥有者，即证明自己的身份</p> <h4 id="_3-6-5-https完整建立连接过程-如下图-t203-6-5-https完整建立连接过程-如下图"><a href="#_3-6-5-https完整建立连接过程-如下图-t203-6-5-https完整建立连接过程-如下图" aria-hidden="true" class="header-anchor">#</a> 3.6.5 HTTPS完整建立连接过程,如下图 [#](#t203.6.5 HTTPS完整建立连接过程,如下图)</h4> <ul><li>首先建立tcp握手连接</li> <li>进行ssl协议的握手密钥交换(Handshake protocal)</li> <li>然后通过共同约定的密钥开始通信</li></ul> <p><img src="http://img.zhufengpeixun.cn/https_protocal.png" alt></p> <h2 id="_3-7-证书-t213-7-证书"><a href="#_3-7-证书-t213-7-证书" aria-hidden="true" class="header-anchor">#</a> 3.7 证书 [#](#t213.7 证书)</h2> <p>证书的作用就是,我和服务端通信,我怎么知道这个服务端是我要真正通信的服务端呢</p> <p><img src="http://img.zhufengpeixun.cn/zhengshu_brower.png" alt></p> <h3 id="_3-7-1-申请和发放证书流程如下-t223-7-1-申请和发放证书流程如下"><a href="#_3-7-1-申请和发放证书流程如下-t223-7-1-申请和发放证书流程如下" aria-hidden="true" class="header-anchor">#</a> 3.7.1 申请和发放证书流程如下 [#](#t223.7.1 申请和发放证书流程如下)</h3> <p><img src="http://img.zhufengpeixun.cn/zhengshu.png" alt></p> <ul><li>服务方 Server 向第三方机构CA提交公钥、组织信息、个人信息(域名)等信息并申请认证;</li> <li>CA通过线上、线下等多种手段验证申请者提供信息的真实性，如组织是否存在、企业是否合法，是否拥有域名的所有权等;</li> <li>如信息审核通过，CA会向申请者签发认证文件-证书。证书包含以下信息：申请者公钥、申请者的组织信息和个人信息、签发机构 CA的信息、有效时间、证书序列号等信息的明文，同时包含一个签名; 签名的产生算法：首先，使用散列函数计算公开的明文信息的信息摘要，然后，采用 CA的私钥对信息摘要进行加密，密文即签名;</li> <li>客户端 Client 向服务器 Server 发出请求时，Server 返回证书文件;</li> <li>客户端 Client 读取证书中的相关的明文信息，采用相同的散列函数计算得到信息摘要，然后，利用对应 CA的公钥解密签名数据，对比证书的信息摘要，如果一致，则可以确认证书的合法性，即公钥合法;</li> <li>客户端还会验证证书相关的域名信息、有效时间等信息; 客户端会内置信任CA的证书信息(包含公钥)，如果CA不被信任，则找不到对应 CA的证书，证书也会被判定非法。</li></ul> <h3 id="_3-7-2-证书链-t233-7-2-证书链"><a href="#_3-7-2-证书链-t233-7-2-证书链" aria-hidden="true" class="header-anchor">#</a> 3.7.2 证书链 [#](#t233.7.2 证书链)</h3> <p><img src="http://img.zhufengpeixun.cn/zhengshulian.png" alt></p> <ul><li>服务器证书 server.pem 的签发者为中间证书机构 inter，inter 根据证书 inter.pem 验证 server.pem 确实为自己签发的有效证书</li> <li>中间证书 inter.pem 的签发 CA 为 root，root 根据证书 root.pem 验证 inter.pem 为自己签发的合法证书;</li> <li>客户端内置信任 CA 的 root.pem 证书，因此服务器证书 server.pem 的被信任。</li> <li>服务器证书、中间证书与根证书在一起组合成一条合法的证书链，证书链的验证是自下而上的信任传递的过程。</li></ul> <h2 id="_2-https服务器-t242-https服务器"><a href="#_2-https服务器-t242-https服务器" aria-hidden="true" class="header-anchor">#</a> 2. https服务器 [#](#t242. https服务器)</h2> <ul><li>HTTPS使用https协议，默认端口号443；</li> <li>HTTPS需要向证书授证中心申请证书；</li> <li>HTTPS服务器与客户端之间传输是经过SSL安全加密后的密文数据； 在创建HTTPS服务器之前，服务器首先需要创建公钥、私钥及证书，步骤如下 创建公钥、私钥及证书</li></ul> <h3 id="_2-1-创建私钥-t252-1-创建私钥"><a href="#_2-1-创建私钥-t252-1-创建私钥" aria-hidden="true" class="header-anchor">#</a> 2.1 创建私钥 [#](#t252.1 创建私钥)</h3> <div class="language-bash extra-class"><pre class="language-bash"><code>openssl genrsa -out privatekey.pem 1024
</code></pre></div><h3 id="_2-2-创建证书签名请求-t262-2-创建证书签名请求"><a href="#_2-2-创建证书签名请求-t262-2-创建证书签名请求" aria-hidden="true" class="header-anchor">#</a> 2.2 创建证书签名请求 [#](#t262.2 创建证书签名请求)</h3> <div class="language-bash extra-class"><pre class="language-bash"><code>openssl req -new -key privatekey.pem -out certrequest.csr
</code></pre></div><h3 id="_2-3-获取证书，线上证书需要经过证书授证中心签名的文件；下面只创建一个学习使用证书-t272-3-获取证书，线上证书需要经过证书授证中心签名的文件；下面只创建一个学习使用证书"><a href="#_2-3-获取证书，线上证书需要经过证书授证中心签名的文件；下面只创建一个学习使用证书-t272-3-获取证书，线上证书需要经过证书授证中心签名的文件；下面只创建一个学习使用证书" aria-hidden="true" class="header-anchor">#</a> 2.3 获取证书，线上证书需要经过证书授证中心签名的文件；下面只创建一个学习使用证书 [#](#t272.3 获取证书，线上证书需要经过证书授证中心签名的文件；下面只创建一个学习使用证书)</h3> <div class="language-bash extra-class"><pre class="language-bash"><code>openssl x509 -req -in certrequest.csr -signkey privatekey.pem -out certificate.pem
</code></pre></div><h3 id="_2-4-创建pfx文件-t282-4-创建pfx文件"><a href="#_2-4-创建pfx文件-t282-4-创建pfx文件" aria-hidden="true" class="header-anchor">#</a> 2.4 创建pfx文件 [#](#t282.4 创建pfx文件)</h3> <div class="language-bash extra-class"><pre class="language-bash"><code>openssl pkcs12 -export -in certificate.pem -inkey privatekey.pem -out certificate.pfx
</code></pre></div><h3 id="_2-5-创建服务器-t292-5-创建服务器"><a href="#_2-5-创建服务器-t292-5-创建服务器" aria-hidden="true" class="header-anchor">#</a> 2.5 创建服务器 [#](#t292.5 创建服务器)</h3> <p>创建HTTPS服务器同HTTP服务器大致相同，需要增加证书，创建HTTPS服务器时通过options参数设置。</p> <div class="language-js extra-class"><pre class="language-js"><code>https<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span>options<span class="token punctuation">,</span><span class="token punctuation">[</span>requestListener<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li><p>pfx 私钥、公钥以及证书</p></li> <li><p>key 私钥</p></li> <li><p>passphrase 为私钥指定密码</p></li> <li><p>cert 公钥</p></li> <li><p>ca 证书，用于指定一组证书，默认属性值为几个著名的证书授权中心,例如VerlSign</p></li> <li><p>crl 指定证书吊销主</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> https <span class="token keyword">from</span> <span class="token string">'https'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> fs <span class="token keyword">from</span> <span class="token string">'fs'</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> pk <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span><span class="token string">'privatekey.pem'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    pc <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span><span class="token string">'certificate.pem'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> opts <span class="token operator">=</span> <span class="token punctuation">{</span>
    key<span class="token punctuation">:</span> pk<span class="token punctuation">,</span>
    cert<span class="token punctuation">:</span> pc
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> server <span class="token operator">=</span> https<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span>opts<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></li></ul> <p>opts参数为一个对象，用于指定创建HTTPS服务器时配置的各种选项，下面只描述几个必要选项：</p> <table><thead><tr><th>属性名</th> <th>说明</th></tr></thead> <tbody><tr><td>pff</td> <td>用于指定从pfx文件读取出的私钥、公钥以及证书（指定该属性后，无需再指定key、cert、ca）</td></tr> <tr><td>key</td> <td>用于指定后缀名为pem的文件，读出私钥</td></tr> <tr><td>cert</td> <td>用于指定后缀名为pem的文件，读出公钥</td></tr> <tr><td>ca</td> <td>用于指定一组证书，默认值为几个著名的证书授证中心</td></tr></tbody></table> <h3 id="_2-6-创建https客户端-t302-6-创建https客户端"><a href="#_2-6-创建https客户端-t302-6-创建https客户端" aria-hidden="true" class="header-anchor">#</a> 2.6 创建HTTPS客户端 [#](#t302.6 创建HTTPS客户端)</h3> <p>在https模块中，可以使用request方法向其它使用HTTPS协议的网站请求数据</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> req <span class="token operator">=</span> https<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span>options<span class="token punctuation">,</span>callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li><p>host 指定域名或目标主机的IP地址</p></li> <li><p>hostname 指定域名或目标主机的IP地址</p></li> <li><p>port 端口号</p></li> <li><p>method 指定请求方法名</p></li> <li><p>path 指下请求路径及查询字符串</p></li> <li><p>headers 客户端请求头对象</p></li> <li><p>auth 指定认证信息部分</p></li> <li><p>agent 指定用户代理,指定false则从连接池中挑选一个连接状态为关闭的https.Agent对象</p></li> <li><p>pfx 指定私钥、公钥和证书</p></li> <li><p>key 指定私钥</p></li> <li><p>cert 公钥</p></li> <li><p>ca 一组证书</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> options <span class="token operator">=</span> <span class="token punctuation">{</span>
        hostname<span class="token punctuation">:</span> <span class="token string">'localhost'</span><span class="token punctuation">,</span>
        port<span class="token punctuation">:</span> <span class="token number">1443</span><span class="token punctuation">,</span>
        path<span class="token punctuation">:</span> <span class="token string">'/'</span><span class="token punctuation">,</span>
        method<span class="token punctuation">:</span> <span class="token string">'post'</span><span class="token punctuation">,</span>
        key<span class="token punctuation">:</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span><span class="token string">'privatekey.pem'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        cert<span class="token punctuation">:</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span><span class="token string">'certificate.pem'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        rejectUnhauthorized<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        agent<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token comment">// 从连接池中指定挑选一个当前连接状态为关闭的https.Agent</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    req <span class="token operator">=</span> https<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 或者</span>
<span class="token keyword">const</span> options <span class="token operator">=</span> <span class="token punctuation">{</span>
        hostname<span class="token punctuation">:</span> <span class="token string">'localhost'</span><span class="token punctuation">,</span>
        port<span class="token punctuation">:</span> <span class="token number">1443</span><span class="token punctuation">,</span>
        path<span class="token punctuation">:</span> <span class="token string">'/'</span><span class="token punctuation">,</span>
        method<span class="token punctuation">:</span> <span class="token string">'post'</span><span class="token punctuation">,</span>
        key<span class="token punctuation">:</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span><span class="token string">'privatekey.pem'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        cert<span class="token punctuation">:</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span><span class="token string">'certificate.pem'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        rejectUnhauthorized<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// 显示指定https.Agent对象</span>
options<span class="token punctuation">.</span>agent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">https<span class="token punctuation">.</span>Agent</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> req <span class="token operator">=</span> https<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></li></ul> <h2 id="_3-8-让你的网站支持https-t313-8-让你的网站支持https"><a href="#_3-8-让你的网站支持https-t313-8-让你的网站支持https" aria-hidden="true" class="header-anchor">#</a> 3.8 让你的网站支持https [#](#t313.8 让你的网站支持https)</h2> <ul><li><p><a href="http://www.laozuo.org/7676.html" target="_blank" rel="noopener noreferrer">实战申请Let's Encrypt永久免费SSL证书过程教程及常见问题<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">git</span> clone https://github.com/letsencrypt/letsencrypt
<span class="token function">cd</span> letsencrypt
<span class="token function">chmod</span> 777 ./letsencrypt-auto
./letsencrypt-auto certonly --standalone --email zhang_renyang@126.com -d itnewhand.com

/etc/letsencrypt/live/itnewhand.com/fullchain.pem
/etc/letsencrypt/live/itnewhand.com/privkey.pem
</code></pre></div></li></ul> <blockquote><p>生成证书时要先停掉nginx</p></blockquote></div> <!----> <div class="content page-nav"><p class="inner"><span class="prev">
          ← <a href="/fe/36.websocket-1.html" class="prev">
            HTTP的架构模式
          </a></span> <span class="next"><a href="/fe/22.cookie.html">
            cookie是什么
          </a> →
        </span></p></div> <div id="comment-container"><div class="gt-container"><div class="gt-initing"><i class="gt-loader"></i> <p class="gt-initing-text">Gitalking ...</p></div> <!----> <!----> <div><div class="gt-header"><a class="gt-avatar-github"><span class="gt-ico gt-ico-github"><span class="gt-svg"><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <path d="M64 524C64 719.602 189.356 885.926 364.113 947.017 387.65799 953 384 936.115 384 924.767L384 847.107C248.118 863.007 242.674 773.052 233.5 758.001 215 726.501 171.5 718.501 184.5 703.501 215.5 687.501 247 707.501 283.5 761.501 309.956 800.642 361.366 794.075 387.658 787.497 393.403 763.997 405.637 743.042 422.353 726.638 281.774 701.609 223 615.67 223 513.5 223 464.053 239.322 418.406 271.465 381.627 251.142 320.928 273.421 269.19 276.337 261.415 334.458 256.131 394.888 302.993 399.549 306.685 432.663 297.835 470.341 293 512.5 293 554.924 293 592.81 297.896 626.075 306.853 637.426 298.219 693.46 258.054 747.5 262.966 750.382 270.652 772.185 321.292 753.058 381.083 785.516 417.956 802 463.809 802 513.5 802 615.874 742.99 701.953 601.803 726.786 625.381 750.003 640 782.295 640 818.008L640 930.653C640.752 939.626 640 948.664978 655.086 948.665 832.344 888.962 960 721.389 960 524 960 276.576 759.424 76 512 76 264.577 76 64 276.576 64 524Z"></path>
</svg>
</span> <!----></span></a> <div class="gt-header-comment"><textarea placeholder="Leave a comment" class="gt-header-textarea"></textarea> <div class="gt-header-preview markdown-body hide"></div> <div class="gt-header-controls"><a href="https://guides.github.com/features/mastering-markdown/" target="_blank" class="gt-header-controls-tip"><span class="gt-ico gt-ico-tip"><span class="gt-svg"><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <path d="M512 366.949535c-16.065554 0-29.982212 13.405016-29.982212 29.879884l0 359.070251c0 16.167882 13.405016 29.879884 29.982212 29.879884 15.963226 0 29.879884-13.405016 29.879884-29.879884L541.879884 396.829419C541.879884 380.763865 528.474868 366.949535 512 366.949535L512 366.949535z"
    p-id="3083"></path>
  <path d="M482.017788 287.645048c0-7.776956 3.274508-15.553912 8.80024-21.181973 5.525732-5.525732 13.302688-8.80024 21.181973-8.80024 7.776956 0 15.553912 3.274508 21.079644 8.80024 5.525732 5.62806 8.80024 13.405016 8.80024 21.181973 0 7.776956-3.274508 15.656241-8.80024 21.181973-5.525732 5.525732-13.405016 8.697911-21.079644 8.697911-7.879285 0-15.656241-3.274508-21.181973-8.697911C485.292295 303.301289 482.017788 295.524333 482.017788 287.645048L482.017788 287.645048z"
    p-id="3084"></path>
  <path d="M512 946.844409c-239.8577 0-434.895573-195.037873-434.895573-434.895573 0-239.8577 195.037873-434.895573 434.895573-434.895573 239.755371 0 434.895573 195.037873 434.895573 434.895573C946.895573 751.806535 751.755371 946.844409 512 946.844409zM512 126.17088c-212.740682 0-385.880284 173.037274-385.880284 385.777955 0 212.740682 173.037274 385.777955 385.880284 385.777955 212.740682 0 385.777955-173.037274 385.777955-385.777955C897.777955 299.208154 724.740682 126.17088 512 126.17088z"
    p-id="3085"></path>
</svg>
</span> <span class="gt-ico-text">Markdown is supported</span></span></a> <!----> <button class="gt-btn gt-btn-preview"><span class="gt-btn-text">Preview</span> <!----></button> <button class="gt-btn gt-btn-login"><span class="gt-btn-text">Login with GitHub</span> <!----></button></div></div></div> <div class="gt-comments"><span></span> <p class="gt-comments-null">
                Be the first guy leaving a comment!
            </p> <!----></div></div></div></div></div></div> <!----></div> <div class="tool-group"><!----></div></div> <!----></div> <div class="background-mask" style="background:#f6f6f6;"></div></div></div>
    <script src="/assets/js/app.35b69267.js" defer></script><script src="/assets/js/31.81741530.js" defer></script>
  </body>
</html>
